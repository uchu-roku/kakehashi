<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KAKEHASHI デモ | 診断結果 v1.3</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="icon" href="data:,">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
<style>
  :root { --bg:#0b1020; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; --accent2:#a78bfa; --chip:#0b1326; --chipb:#2a3953; }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 600px at 80% -10%, rgba(167,139,250,.25), transparent),var(--bg);color:var(--text);font-family:Inter,system-ui,"Noto Sans JP",sans-serif}
  header{padding:24px;border-bottom:1px solid #1f2937;position:sticky;top:0;background:linear-gradient(180deg,rgba(17,24,39,.9),rgba(17,24,39,.7));backdrop-filter:blur(6px);z-index:10}
  .wrap{max-width:1200px;margin:0 auto;padding:24px}
  h1{margin:0 0 8px;font-size:26px}
  .lead{color:var(--muted);margin:0 0 16px}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
  .card{background:linear-gradient(180deg,rgba(31,41,55,.75),rgba(17,24,39,.9));border:1px solid #243045;border-radius:14px;padding:16px}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .chip{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--chipb);background:var(--chip);font-size:12px;color:#cbd5e1}
  .result-card{background:#0f172a;border:1px solid #243045;border-radius:12px;padding:14px;margin:10px 0}
  .result-card h3{margin:0 0 6px;font-size:16px}
  .result-card .meta{font-size:12px;color:#9ca3af;margin-bottom:6px}
  .result-card .btn{appearance:none;border:none;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0b1020}
  .btn-ghost{background:transparent;color:#cbd5e1;border:1px solid #2a3953}
  #map{width:100%;height:420px;border-radius:12px;border:1px solid #243045}
  #legend .item{display:flex;align-items:center;gap:8px;font-size:12px;margin:6px 0}
  #legend .sw{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:4px;border:1px solid #334155}
  #aiOverlay{display:none;position:absolute;inset:0;background:rgba(0,0,0,.35);align-items:center;justify-content:center;border-radius:12px}
  #aiOverlay .spinner{border:3px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;width:36px;height:36px;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;">
    <h1 style="margin:0">診断結果</h1>
    <a href="./" class="chip" style="text-decoration:none">← 入力に戻る</a>
  </div>
</header>

<main class="wrap">
  <p class="lead" id="leadText">あなたの入力に基づき、関連するソリューション候補を提示します。</p>

  <div class="chips" id="formChips"></div>

  <div class="grid">
    <!-- 左：候補一覧 -->
    <section class="card">
      <h2 style="margin:0 0 6px;font-size:18px">提案一覧</h2>
      <div id="resultsGrid"></div>
    </section>

    <!-- 右：デモビューワ -->
    <section class="card" style="position:relative">
      <h2 style="margin:0 0 6px;font-size:18px">デモビューワ</h2>
      <div id="demoMeta" style="font-size:12px;color:#9ca3af;margin-bottom:6px">デモ未選択</div>
      <div style="position:relative">
        <div id="map"></div>
        <div id="aiOverlay"><div class="spinner"></div></div>
      </div>
      <div id="legend" style="margin-top:10px"></div>
      <p id="scenario" style="margin-top:10px;color:#cbd5e1;font-size:14px">ここにデモの活用シナリオが表示されます。</p>
      <div id="demoActions" style="display:flex;gap:8px;margin-top:6px"></div>
    </section>
  </div>
</main>

<footer style="color:#6b7280;text-align:center;font-size:12px;padding:24px;">© 2025 KAKEHASHI Project – Prototype (v1.3)</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const chipsEl   = document.getElementById('formChips');
  const grid      = document.getElementById('resultsGrid');
  const leadText  = document.getElementById('leadText');
  const overlayEl = document.getElementById('aiOverlay');
  const legendEl  = document.getElementById('legend');
  const scenarioEl = document.getElementById('scenario');
  const demoActionsEl = document.getElementById('demoActions');

  // 入力の復元
  const params = new URLSearchParams(location.search);
  const form = {
    industry: params.get('industry') || (JSON.parse(localStorage.getItem('kakehashi:lastForm')||'{}').industry||''),
    region  : params.get('region') || '',
    problem : params.get('problem') || '',
    kpis    : (params.get('kpi')||'').split(',').filter(Boolean)
  };
  const segs = JSON.parse(localStorage.getItem('kakehashi:lastSegs')||'[]');
  const forceDemoId = params.get('demo_id');

  console.info('[KAKEHASHI/results] form=', form, 'segs=', segs, 'forceDemoId=', forceDemoId);

  // SEG→既定デモ
  const DEMO_BY_SEG = {
    "SEG_FLOOD": "flood_fukuoka_20240712",
    "SEG_FORESTRY_SME": "forestry_hokkaido_202405",
    "SEG_REDTIDE": "redtide_seto_202408",
    "SEG_AGRI_PROD": "agri_ndvi_hokkaido_202406",
    "SEG_METHANE": "methane_toc_202501"
  };
  // 業界→既定デモ（SEGが無い時の保険）
  const DEMO_BY_INDUSTRY = {
    "林業": "forestry_hokkaido_202405",
    "災害": "flood_fukuoka_20240712",
    "農業": "agri_ndvi_hokkaido_202406",
    "水環境": "redtide_seto_202408",
    "エネルギー": "methane_toc_202501",
    "インフラ点検": "flood_fukuoka_20240712"
  };

  // ソリューションDB（空でも必ず配列）
  window.DB = window.DB || {};
  window.DB.solutions = window.DB.solutions || [
    { sol_id:"sol_flood_01", title:"洪水・浸水深推定", provider:"KAKEHASHI Demo", service_name:"Flood Insight", use_case_category:"災害", description:"豪雨時の浸水深を把握して優先点検ルートを策定。", linked_segments:"SEG_FLOOD;SEG_EMERGENCY;SEG_INSURANCE", region_hint:["福岡","九州"], default_demo_id:"flood_fukuoka_20240712", data_sources:"SAR/DEM", delivery_access:"WebUI/API" },
    { sol_id:"sol_agri_01", title:"NDVI圃場モニタ", provider:"KAKEHASHI Demo", service_name:"Agri NDVI", use_case_category:"農業", description:"生育ムラを見える化し、追肥判断を支援。", linked_segments:"SEG_AGRI_PROD", region_hint:["北海道","空知","札幌"], default_demo_id:"agri_ndvi_hokkaido_202406", data_sources:"Sentinel-2", delivery_access:"WebUI" },
    { sol_id:"sol_forest_01", title:"森林在庫（齢級推定）", provider:"KAKEHASHI Demo", service_name:"Forest Stock", use_case_category:"林業", description:"齢級分布から施業対象区画を抽出。", linked_segments:"SEG_FORESTRY_SME;SEG_FORESTRY_PUBLIC", region_hint:["北海道","道央"], default_demo_id:"forestry_hokkaido_202405", data_sources:"SAR/光学/DEM", delivery_access:"WebUI" },
    { sol_id:"sol_methane_01", title:"メタン/フレア監視", provider:"KAKEHASHI Demo", service_name:"Methane TOC", use_case_category:"エネルギー", description:"CH4ホットスポットを継続監視し、ESG報告に活用。", linked_segments:"SEG_METHANE;SEG_REGULATOR;SEG_OILGAS", region_hint:["湾岸","プラント"], default_demo_id:"methane_toc_202501", data_sources:"SWIR/TIR", delivery_access:"WebUI/API" },
    { sol_id:"sol_redtide_01", title:"赤潮・クロロフィル指標", provider:"KAKEHASHI Demo", service_name:"HAB Monitor", use_case_category:"水環境", description:"クロロフィル濃度の高い海域を広域監視。", linked_segments:"SEG_REDTIDE;SEG_AQUA_SME", region_hint:["瀬戸内","内海"], default_demo_id:"redtide_seto_202408", data_sources:"光学", delivery_access:"WebUI" }
  ];

  // -------- スコアリング / 描画 --------
  function regionMatchScore(hints, reg){ if(!hints || !reg) return 0; const t = reg.toLowerCase(); return hints.some(h=>t && t.includes(h.toLowerCase()))?1:0; }
  function tokenizeJa(s){ return (s||"").toLowerCase().split(/[^\p{Letter}\p{Number}]+/u).filter(Boolean); }
  function jaccard(a,b){ const A=new Set(a),B=new Set(b); const inter=[...A].filter(x=>B.has(x)).length; const uni=new Set([...A,...B]).size; return uni?(inter/uni):0; }
  function scoreSolution(sol, form){
    let score=0; const reasons=[];
    const indKey = (form.industry||'').split('/')[0];
    if(sol.use_case_category && indKey && sol.use_case_category.includes(indKey)){ score+=2; reasons.push('業界一致'); }
    const kpiHits = form.kpis.filter(k => (sol.title+sol.description).includes(k)).length;
    if(kpiHits>0){ score += kpiHits; reasons.push(`KPI一致×${kpiHits}`); }
    const linked = (sol.linked_segments||"").split(';').filter(Boolean);
    const segHit = linked.filter(s=>segs.includes(s)).length;
    if(segHit>0){ score += segHit*3; reasons.push(`SEG一致×${segHit}`); }
    const sim = jaccard(tokenizeJa(form.problem), tokenizeJa(`${sol.title} ${sol.description} ${sol.use_case_category}`));
    const simPts = Math.round(sim*3); score += simPts; if(simPts>0) reasons.push(`文章類似${(sim*100).toFixed(0)}%`);
    const regPts = regionMatchScore(sol.region_hint||[], form.region);
    if(regPts>0){ score += regPts; reasons.push('地域近接'); }
    return {score, reasons};
  }

  function renderFormChips(){
    if(!chipsEl) return;
    chipsEl.innerHTML = "";
    if(form.industry){ const d=document.createElement('div'); d.className='chip'; d.textContent=`業界: ${form.industry}`; chipsEl.appendChild(d); }
    if(form.region){ const d=document.createElement('div'); d.className='chip'; d.textContent=`地域: ${form.region}`; chipsEl.appendChild(d); }
    if(form.kpis.length){ const d=document.createElement('div'); d.className='chip'; d.textContent=`KPI: ${form.kpis.join(' / ')}`; chipsEl.appendChild(d); }
    if(segs.length){ const d=document.createElement('div'); d.className='chip'; d.textContent=`SEG: ${segs.join(', ')}`; chipsEl.appendChild(d); }
  }

  function ensureFallbackSolutions(scored){
    if(scored.length>0) return scored;

    console.info('[KAKEHASHI/results] fallback: no scored solutions, generating from SEG/industry');
    // SEG優先 → なければ industry で 1件作る
    const segDemo = segs.map(s=>DEMO_BY_SEG[s]).find(Boolean);
    const indKey  = (form.industry||'').split('/')[0];
    const indDemo = DEMO_BY_INDUSTRY[indKey] || null;
    const demoId  = segDemo || indDemo;

    if(demoId){
      const titleMap = {
        'forestry_hokkaido_202405':'森林在庫（齢級推定）',
        'flood_fukuoka_20240712':'洪水・浸水深推定',
        'agri_ndvi_hokkaido_202406':'NDVI圃場モニタ',
        'redtide_seto_202408':'赤潮・クロロフィル指標',
        'methane_toc_202501':'メタン/フレア監視'
      };
      const categoryMap = {
        'forestry_hokkaido_202405':'林業','flood_fukuoka_20240712':'災害','agri_ndvi_hokkaido_202406':'農業','redtide_seto_202408':'水環境','methane_toc_202501':'エネルギー'
      };
      const sol = {
        sol_id:'fallback_01',
        title: titleMap[demoId] || '関連デモ',
        provider:'KAKEHASHI Demo',
        service_name:'Demo',
        use_case_category: categoryMap[demoId] || (indKey||''),
        description:'入力に近いデモをプレビューできます。',
        linked_segments: (segs.join(';')||''),
        region_hint: [],
        default_demo_id: demoId,
        data_sources:'—',
        delivery_access:'WebUI'
      };
      const scoredOne = {...sol, _score:1, _reasons:['簡易一致（fallback）']};
      return [scoredOne];
    }
    return [];
  }

  function renderResults(){
    if(!grid || !leadText) return;
    grid.innerHTML = "";

    let scored = (window.DB.solutions||[]).map(sol=>{
      const {score,reasons} = scoreSolution(sol, form);
      return {...sol,_score:score,_reasons:reasons};
    }).sort((a,b)=>b._score-a._score);

    scored = ensureFallbackSolutions(scored);

    if(scored.length){
      leadText.textContent = `入力内容に基づき ${scored.length} 件の候補を見つけました。合致度の高い順に表示しています。`;
      scored.slice(0,8).forEach(sol=>{
        const card=document.createElement('div'); card.className='result-card';
        const h=document.createElement('h3'); h.innerHTML=`<span class="score">[${sol._score}]</span> ${sol.title}`;
        const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`${sol.provider} / ${sol.service_name} ｜ カテゴリ: ${sol.use_case_category}`;
        const p=document.createElement('p'); p.textContent=sol.description;

        const chips=document.createElement('div'); chips.className='chips';
        (sol._reasons||[]).forEach(r=>{ const c=document.createElement('div'); c.className='chip'; c.textContent=r; chips.appendChild(c); });

        const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='8px';
        const btnDemo=document.createElement('button'); btnDemo.className='btn btn-primary'; btnDemo.textContent='デモを見る';
        btnDemo.onclick=()=>openDemo(sol.default_demo_id, sol.title, true);
        const btnDetail=document.createElement('button'); btnDetail.className='btn btn-ghost'; btnDetail.textContent='詳細（シナリオ）';
        btnDetail.onclick=()=>openDemo(sol.default_demo_id, sol.title, true);
        actions.appendChild(btnDemo); actions.appendChild(btnDetail);

        card.appendChild(h); card.appendChild(meta); card.appendChild(p); card.appendChild(chips); card.appendChild(actions);
        grid.appendChild(card);
      });
    }else{
      leadText.textContent = '該当するソリューションが見つかりませんでした。右側の「デモを見る」ボタンでプレビューできます。';
    }

    // 初回オートデモ（SEG→業界の順で決定）
    const autoDemo = segs.map(s=>DEMO_BY_SEG[s]).find(Boolean) ||
                     DEMO_BY_INDUSTRY[(form.industry||'').split('/')[0]] ||
                     null;
    if(forceDemoId){ openDemo(forceDemoId, 'プレビュー', true); }
    else if(autoDemo){ openDemo(autoDemo, 'プレビュー', false); }
  }

  // --------- 地図／デモ ----------
  let map, overlayTile, overlayImage, vectorLayers = {};
  function ensureMap(center=[35,135], zoom=5){
    if(!map){
      map = L.map('map');
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
    }
    map.setView(center, zoom);
  }

  function addOpacityControl(layerRef, init=0.8){
    const old = document.getElementById('opacityCtl'); if(old) old.remove();
    const wrap = document.createElement('div');
    wrap.id = 'opacityCtl';
    wrap.style.marginTop = '10px';
    wrap.innerHTML = `
      <label style="font-size:12px;color:#9ca3af;">オーバーレイ不透明度</label>
      <input type="range" min="0" max="1" step="0.05" value="${init}" style="width:240px;display:block;margin-top:4px;">`;
    legendEl.insertAdjacentElement('afterend', wrap);
    wrap.querySelector('input').addEventListener('input', (ev)=>{
      const v = parseFloat(ev.target.value);
      if(layerRef && layerRef.setOpacity) layerRef.setOpacity(v);
      if(overlayImage && overlayImage.setOpacity) overlayImage.setOpacity(v);
    });
  }

  function renderMetrics(metrics){
    const old = document.getElementById('metricBar'); if(old) old.remove();
    if(!Array.isArray(metrics) || metrics.length===0) return;
    const bar = document.createElement('div');
    bar.id = 'metricBar';
    bar.style.display='flex'; bar.style.flexWrap='wrap'; bar.style.gap='8px'; bar.style.marginTop='10px';
    metrics.forEach(m=>{
      const card = document.createElement('div');
      card.className = 'chip';
      card.innerHTML = `<strong>${m.value}</strong>｜${m.label}`;
      bar.appendChild(card);
    });
    scenarioEl.insertAdjacentElement('beforebegin', bar);
  }

  async function openDemo(demoId, title, scrollToScenario=false){
    if(!demoId){ console.info('[KAKEHASHI/results] openDemo: demoId is empty'); return; }
    const url = `public/demos/${demoId}/index.json`;
    overlayEl.style.display='flex';
    let meta=null;
    try{
      const res=await fetch(url,{cache:'no-store'}); if(res.ok) meta=await res.json();
    }catch(e){ console.warn('fetch demo meta failed', e); }
    meta = meta || { title:`${title}（デモ情報未設定）`, last_obs:'', tileUrl:'', center:[35,135], zoom:5, legend:[] };

    // 地域センタリング微調整
    if(/札幌/i.test(form.region)) meta.center=[43.06,141.35];
    if(/北海道/i.test(form.region)) meta.center=[43.22,142.86];
    if(/福岡/i.test(form.region)) meta.center=[33.59,130.40];

    document.getElementById('demoMeta').textContent =
      `${meta.title}｜最終観測: ${meta.last_obs||'—'}｜提供: ${meta.provider||'—'}｜データ源: ${meta.data_source||meta.data_sources||'—'}`;

    ensureMap(meta.center, meta.zoom||12);

    // オーバーレイをクリア
    if(overlayTile){ overlayTile.remove(); overlayTile=null; }
    if(overlayImage){ overlayImage.remove(); overlayImage=null; }
    Object.values(vectorLayers).forEach(v=>v.remove()); vectorLayers = {};

    if(meta.tileUrl){
      overlayTile = L.tileLayer(meta.tileUrl,{maxZoom:19,opacity:.85}).addTo(map);
    }
    if(meta.overlay && meta.overlay.type==='image' && meta.overlay.url && Array.isArray(meta.overlay.bbox)){
      const b = meta.overlay.bbox; // [minX, minY, maxX, maxY]
      const imgBounds = [[b[1], b[0]], [b[3], b[2]]];
      overlayImage = L.imageOverlay(meta.overlay.url, imgBounds, {opacity: meta.overlay.opacity ?? 0.8}).addTo(map);
      addOpacityControl(overlayImage, meta.overlay.opacity ?? 0.8);
    }else if(overlayTile){
      addOpacityControl(overlayTile, 0.85);
    }

    if(Array.isArray(meta.layers)){
      for(const lyr of meta.layers){
        if(lyr.type==='geojson' && lyr.url){
          try{
            const res = await fetch(lyr.url,{cache:'no-store'});
            if(res.ok){
              const gj = await res.json();
              const style = lyr.style || {color:'#22d3ee',weight:1,opacity:.6,fillOpacity:0.0};
              vectorLayers[lyr.id] = L.geoJSON(gj,{style}).addTo(map);
            }
          }catch(e){ console.warn('vector layer load failed', lyr.url); }
        }
      }
    }

    // 凡例／メトリクス／CTA
    legendEl.innerHTML='';
    (meta.legend||[]).forEach(it=>{
      const d=document.createElement('div'); d.className='item';
      const sw=document.createElement('span'); sw.className='sw';
      sw.style.background = it.color || '#334155';
      sw.textContent = it.icon || '';
      const t=document.createElement('span'); t.textContent=it.label||''; d.appendChild(sw); d.appendChild(t);
      legendEl.appendChild(d);
    });
    renderMetrics(meta.metrics);
    scenarioEl.textContent = meta.scenario || meta.scenario_text || 'このデモの活用ストーリーは準備中です。';

    demoActionsEl.innerHTML='';
    const btnLocal=document.createElement('button'); btnLocal.className='btn btn-primary';
    btnLocal.textContent='自分の地域でも試せますか？';
    btnLocal.onclick=()=> window.open((meta.cta?.href || 'mailto:contact@example.com?subject=デモ相談&body=地域: '+(form.region||'')), '_blank','noopener');
    demoActionsEl.appendChild(btnLocal);
    if(meta.cta && meta.cta.href){
      const btn=document.createElement('a'); btn.className='btn btn-ghost'; btn.textContent=meta.cta.text||'相談する';
      btn.href=meta.cta.href; btn.target='_blank'; btn.rel='noopener';
      demoActionsEl.appendChild(btn);
    }

    overlayEl.style.display='none';
    if(scrollToScenario) scenarioEl.scrollIntoView({behavior:'smooth',block:'nearest'});
  }

  // 初期描画
  renderFormChips();
  renderResults();
});
</script>
</body>
</html>
