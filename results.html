<script>
document.addEventListener('DOMContentLoaded', () => {
  // ---------- DOM ----------
  const chipsEl      = document.getElementById('formChips');
  const grid         = document.getElementById('resultsGrid');
  const leadText     = document.getElementById('leadText');
  const scenarioEl   = document.getElementById('scenario');
  const demoActionsEl= document.getElementById('demoActions');
  const demoMetaEl   = document.getElementById('demoMeta');
  const docEl        = document.getElementById('docViewer');
  const creditEl     = document.getElementById('creditNote');

  // ---------- 入力の復元（URL優先 → localStorage） ----------
  const urlParams = new URLSearchParams(location.search);
  const lastForm  = JSON.parse(localStorage.getItem('kakehashi:lastForm')||'{}');
  const form = {
    industry: urlParams.get('industry') || lastForm.industry || '',
    region  : urlParams.get('region')   || lastForm.region   || '',
    problem : urlParams.get('problem')  || lastForm.problem  || '',
    kpis    : (urlParams.get('kpi')||'').split(',').filter(Boolean).length
               ? (urlParams.get('kpi')||'').split(',').filter(Boolean)
               : (lastForm.kpis||[])
  };
  const forcedDemoId = urlParams.get('demo_id') || '';

  // ---------- 共有状態 ----------
  let DEMOS = [];

  // ---------- Utils ----------
  const esc = s => (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const md  = (s='') => esc(s)
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/^-\s(.+)$/gm,'<li>$1</li>')
    .replace(/(<li>[\s\S]*?<\/li>)/g,'<ul>$1</ul>')
    .replace(/\n/g,'<br>');

  const IND2CAT = (ind='') => (ind.split('/')[0] || '').trim();
  const tokenizeJa = (s='') =>
    s.toLowerCase()
     .replace(/[Ａ-Ｚａ-ｚ０-９]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0xFEE0))
     .split(/[^\p{Letter}\p{Number}]+/u).filter(Boolean);
  const jaccard = (a,b) => {
    const A=new Set(a), B=new Set(b);
    const inter=[...A].filter(x=>B.has(x)).length;
    const uni  =new Set([...A,...B]).size;
    return uni ? inter/uni : 0;
  };

  // 自然文 → カテゴリ推定
  const CAT_HINT_RULES = [
    {rx:/林業|齢級|立木|路網|材積/,            cat:'林業'},
    {rx:/洪水|浸水|冠水|台風|氾濫|内水|外水/,    cat:'災害'},
    {rx:/圃場|作付|生育|収量|NDVI|追肥|水稲/,    cat:'農業'},
    {rx:/赤潮|クロロフィル|藻類|HAB|養殖|海況/,  cat:'水環境'},
    {rx:/メタン|フレア|排出|ESG|CH4|ガス|オイル/, cat:'エネルギー'}
  ];
  const inferCatsFromProblem = (text='') =>
    Array.from(new Set(CAT_HINT_RULES.filter(r => r.rx.test(text)).map(r => r.cat)));

  // ---------- スコアリング ----------
  function scoreDemo(demo, form){
    let score = 0, reasons = [];
    const indCat = IND2CAT(form.industry);
    const probText = form.problem || '';
    const kpis = Array.isArray(form.kpis) ? form.kpis : [];

    // 1) カテゴリ一致（業界プルダウン）
    if (indCat && demo.category === indCat){ score += 3; reasons.push('業界カテゴリ一致'); }

    // 2) 自然文からのカテゴリ推定一致
    const inferred = inferCatsFromProblem(probText);
    if (inferred.includes(demo.category)){ score += 2; reasons.push('自然文カテゴリ一致'); }

    // 3) 文章類似（自然文 vs デモ本文）
    const demoText = [
      demo.title, demo.summary, ...(demo.bullets||[]),
      ...((demo.steps||[]).map(s => `${s.title} ${s.body_md||''}`)),
      ...(demo.tags||[])
    ].join(' ');
    const sim = jaccard(tokenizeJa(probText), tokenizeJa(demoText));
    if (sim > 0){
      const pts = Math.min(3, Math.round(sim*4)); // 0〜3点
      score += pts;
      if (pts>0) reasons.push(`文章類似 ${(sim*100|0)}%`);
    }

    // 4) KPI一致
    const demoKpis = new Set(demo.kpis||[]);
    const kpiHits = kpis.filter(k => demoKpis.has(k)).length;
    if (kpiHits){ score += kpiHits*2; reasons.push(`KPI一致×${kpiHits}`); }

    // 5) 地域ヒント
    if ((demo.region_hint||[]).some(h => (form.region||'').includes(h))){ score += 1; reasons.push('地域近接'); }

    return {score, reasons};
  }

  // ---------- フィルタ ----------
  function filterDemos(all, form, {minScore=1, limit=8} = {}) {
    // 通常のスコアリング
    let scored = all
      .map(d => ({ ...d, _rank: scoreDemo(d, form) }))
      .filter(x => x._rank.score >= minScore)
      .sort((a, b) => b._rank.score - a._rank.score);

    // 0件 → 自然文カテゴリ推定でフォールバック（全件には落とさない）
    if (scored.length === 0) {
      const inferred = inferCatsFromProblem(form.problem || '');
      if (inferred.length) {
        scored = all
          .filter(d => inferred.includes(d.category))
          .map(d => ({ ...d, _rank: { score: 1, reasons: ['簡易一致（カテゴリ推定）'] } }));
      }
    }
    // そのまま返す（0件は0件のまま UI がメッセージ表示）
    return scored.slice(0, limit);
  }

  // ---------- 文書デモの描画 ----------
  function renderDoc(demo){
    if(!demo){
      demoMetaEl.textContent = 'デモ未選択';
      docEl.innerHTML = '<div class="note">デモを選択してください。</div>';
      creditEl.style.display='none';
      creditEl.innerHTML='';
      demoActionsEl.innerHTML='';
      scenarioEl.textContent='（MVP：文章でのシナリオ記述）';
      return;
    }
    demoMetaEl.textContent =
      `${demo.title}｜カテゴリ: ${demo.category||'—'}｜データ源: ${(demo.data_sources||[]).join('/')}｜最終観測: ${demo.last_obs||'—'}`;

    const bullets = (demo.bullets||[]).map(x=>`<li>${esc(x)}</li>`).join('');
    const steps = (demo.steps||[]).map(st=>
      `<h3>■ ${esc(st.title)}</h3><div>${md(st.body_md||'')}</div>`
    ).join('');
    const kpis = (demo.kpis||[]).map(k=>`<span class="chip" style="margin-right:6px">${esc(k)}</span>`).join('');

    docEl.innerHTML = `
      <h3 style="margin-top:0">${esc(demo.title)}</h3>
      <div style="color:#9ca3af;margin:6px 0">${esc(demo.summary||'—')}</div>
      ${bullets?`<ul style="margin-top:8px">${bullets}</ul>`:''}
      <div style="margin-top:10px">${steps}</div>
      ${kpis?`<div style="margin-top:12px">${kpis}</div>`:''}
    `;

    if(demo.credit?.href){
      creditEl.innerHTML = `出典: <a href="${demo.credit.href}" target="_blank" rel="noopener">${esc(demo.credit.label||demo.credit.href)}</a>`;
      creditEl.style.display = 'block';
    }else{
      creditEl.style.display = 'none';
      creditEl.innerHTML = '';
    }

    demoActionsEl.innerHTML = '';
    if(demo.cta?.href){
      const a = document.createElement('a');
      a.className='btn btn-primary';
      a.href = demo.cta.href; a.target='_blank'; a.rel='noopener';
      a.textContent = demo.cta.label || '相談する';
      demoActionsEl.appendChild(a);
    }
    scenarioEl.textContent = demo.scenario || '（MVP：文章でのシナリオ記述）';
  }

  function renderResults(list){
    grid.innerHTML = '';

    if (list.length === 0){
      leadText.textContent = '入力内容に合致する文書デモは見つかりませんでした。条件を広げてお試しください。';
      grid.insertAdjacentHTML('beforeend',
        '<div class="result-card"><p style="margin:0;color:#9ca3af;">該当する候補がありません。</p></div>');
      return;
    }

    leadText.textContent = `文書デモ ${list.length} 件を表示（入力内容に基づき抽出）`;
    list.forEach(demo=>{
      const card=document.createElement('div'); card.className='result-card';
      const h=document.createElement('h3'); h.innerHTML= esc(demo.title);
      const meta=document.createElement('div'); meta.className='meta';
      meta.textContent = `カテゴリ: ${demo.category||'—'} ｜ タグ: ${(demo.tags||[]).join(', ')}`;
      const p=document.createElement('p'); p.textContent = demo.summary||'—';

      if (demo._rank?.reasons?.length){
        const chips=document.createElement('div'); chips.className='chips';
        demo._rank.reasons.forEach(r=>{
          const c=document.createElement('div'); c.className='chip'; c.textContent=r; chips.appendChild(c);
        });
        card.appendChild(chips);
      }

      const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='8px';
      const btn=document.createElement('button'); btn.className='btn btn-primary'; btn.textContent='デモを見る';
      btn.onclick=()=> openDemoDoc(demo.id);
      actions.appendChild(btn);

      card.appendChild(h); card.appendChild(meta); card.appendChild(p); card.appendChild(actions);
      grid.appendChild(card);
    });
  }

  function openDemoDoc(id){
    const d = DEMOS.find(x=>x.id===id);
    renderDoc(d);
    const q = new URLSearchParams(location.search); q.set('demo_id', id);
    history.replaceState(null, '', location.pathname+'?'+q.toString());
  }

  // ---------- 起動：JSON読込 → 抽出 → 描画 ----------
  fetch('public/demos/demos.json', {cache:'no-store'})
    .then(r=>r.json())
    .then(json=>{
      DEMOS = json.demos||[];

      // 入力チップ
      chipsEl.innerHTML='';
      if(form.industry){ chipsEl.insertAdjacentHTML('beforeend', `<div class="chip">業界: ${esc(form.industry)}</div>`); }
      if(form.region){   chipsEl.insertAdjacentHTML('beforeend', `<div class="chip">地域: ${esc(form.region)}</div>`); }
      if(form.kpis?.length){ chipsEl.insertAdjacentHTML('beforeend', `<div class="chip">KPI: ${esc(form.kpis.join(' / '))}</div>`); }
      if(form.problem){  chipsEl.insertAdjacentHTML('beforeend', `<div class="chip">自然文あり</div>`); }

      // 入力シグナル（どれか入っていれば true）
      const hasSignal =
        (form.industry && form.industry.trim()) ||
        (form.problem  && form.problem.trim())  ||
        (Array.isArray(form.kpis) && form.kpis.length) ||
        (form.region   && form.region.trim());

      let filtered = [];

      if (hasSignal){
        filtered = filterDemos(DEMOS, form, {minScore:1, limit:8});
      } else {
        const defId = json.default_demo_id || (DEMOS[0]?.id);
        filtered = DEMOS.filter(d => d.id === defId);
        leadText.textContent = '（入力が未指定のため）代表的な文書デモのみ表示しています。';
      }

      renderResults(filtered);

      // 初期選択
      const initial = forcedDemoId || (filtered[0]?.id) || json.default_demo_id || (DEMOS[0]?.id);
      if(initial) openDemoDoc(initial);
    })
    .catch(()=>{
      docEl.innerHTML='<div class="note">demos.json の読込に失敗しました。</div>';
    });
});
</script>
