<script>
  const params = new URLSearchParams(location.search);
  const form = {
    industry: params.get('industry') || (JSON.parse(localStorage.getItem('kakehashi:lastForm')||'{}').industry||''),
    region: params.get('region') || '',
    problem: params.get('problem') || '',
    kpis: (params.get('kpi')||'').split(',').filter(Boolean)
  };
  const segs = JSON.parse(localStorage.getItem('kakehashi:lastSegs')||'[]');
  const forceDemoId = params.get('demo_id');

  const DEMO_BY_SEG = {
    "SEG_FLOOD": "flood_fukuoka_20240712",
    "SEG_FORESTRY_SME": "forestry_hokkaido_202405",
    "SEG_REDTIDE": "redtide_seto_202408",
    "SEG_AGRI_PROD": "agri_ndvi_hokkaido_202406",
    "SEG_METHANE": "methane_toc_202501"
  };

  function regionMatchScore(solRegionHint, userRegion){
    if(!solRegionHint || !userRegion) return 0;
    const t = userRegion.toLowerCase();
    return solRegionHint.some(h => t.includes(h)) ? 1 : 0;
  }
  function tokenizeJa(s){ return (s||"").toLowerCase().split(/[^\p{Letter}\p{Number}]+/u).filter(Boolean); }
  function jaccard(a,b){ const A=new Set(a),B=new Set(b); const inter=[...A].filter(x=>B.has(x)).length; const uni=new Set([...A,...B]).size; return uni?(inter/uni):0; }

  window.DB = window.DB || {};
  window.DB.solutions = window.DB.solutions || [
    { sol_id:"sol_flood_01", title:"洪水・浸水深推定", provider:"KAKEHASHI Demo", service_name:"Flood Insight", use_case_category:"災害", description:"豪雨時の浸水深を把握して優先点検ルートを策定。", linked_segments:"SEG_FLOOD;SEG_EMERGENCY;SEG_INSURANCE", region_hint:["福岡","九州"], default_demo_id:"flood_fukuoka_20240712", data_sources:"SAR/DEM", delivery_access:"WebUI/API" },
    { sol_id:"sol_agri_01", title:"NDVI圃場モニタ", provider:"KAKEHASHI Demo", service_name:"Agri NDVI", use_case_category:"農業", description:"生育ムラを見える化し、追肥判断を支援。", linked_segments:"SEG_AGRI_PROD", region_hint:["北海道","空知","札幌"], default_demo_id:"agri_ndvi_hokkaido_202406", data_sources:"Sentinel-2", delivery_access:"WebUI" },
    { sol_id:"sol_forest_01", title:"森林在庫（齢級推定）", provider:"KAKEHASHI Demo", service_name:"Forest Stock", use_case_category:"林業", description:"齢級分布から施業対象区画を抽出。", linked_segments:"SEG_FORESTRY_SME;SEG_FORESTRY_PUBLIC", region_hint:["北海道","道央"], default_demo_id:"forestry_hokkaido_202405", data_sources:"SAR/光学/DEM", delivery_access:"WebUI" },
    { sol_id:"sol_methane_01", title:"メタン/フレア監視", provider:"KAKEHASHI Demo", service_name:"Methane TOC", use_case_category:"エネルギー", description:"CH4ホットスポットを継続監視し、ESG報告に活用。", linked_segments:"SEG_METHANE;SEG_REGULATOR;SEG_OILGAS", region_hint:["湾岸","プラント"], default_demo_id:"methane_toc_202501", data_sources:"SWIR/TIR", delivery_access:"WebUI/API" },
    { sol_id:"sol_redtide_01", title:"赤潮・クロロフィル指標", provider:"KAKEHASHI Demo", service_name:"HAB Monitor", use_case_category:"水環境", description:"クロロフィル濃度の高い海域を広域監視。", linked_segments:"SEG_REDTIDE;SEG_AQUA_SME", region_hint:["瀬戸内","内海"], default_demo_id:"redtide_seto_202408", data_sources:"光学", delivery_access:"WebUI" }
  ];

  function scoreSolution(sol, form){
    let score=0; const reasons=[];
    if(sol.use_case_category && sol.use_case_category.includes((form.industry||'').split('/')[0])){ score+=2; reasons.push('業界一致'); }
    const kpiHits = form.kpis.filter(k => (sol.title+sol.description).includes(k)).length;
    if(kpiHits>0){ score += kpiHits; reasons.push(`KPI一致×${kpiHits}`); }
    const linked = (sol.linked_segments||"").split(';').filter(Boolean);
    const segHit = linked.filter(s=>segs.includes(s)).length;
    if(segHit>0){ score += segHit*3; reasons.push(`SEG一致×${segHit}`); }
    const sim = jaccard(tokenizeJa(form.problem), tokenizeJa(`${sol.title} ${sol.description} ${sol.use_case_category}`));
    const simPts = Math.round(sim*3); score += simPts; if(simPts>0) reasons.push(`文章類似${(sim*100).toFixed(0)}%`);
    const regPts = regionMatchScore(sol.region_hint||[], form.region);
    if(regPts>0){ score += regPts; reasons.push('地域近接'); }
    return {score, reasons};
  }

  const grid = document.getElementById('resultsGrid');
  const chipsEl = document.getElementById('formChips');
  const leadText = document.getElementById('leadText');

  function renderFormChips(){
    chipsEl.innerHTML = "";
    if(form.industry){ const d=document.createElement('div'); d.className='chip'; d.textContent=`業界: ${form.industry}`; chipsEl.appendChild(d); }
    if(form.region){ const d=document.createElement('div'); d.className='chip'; d.textContent=`地域: ${form.region}`; chipsEl.appendChild(d); }
    if(form.kpis.length){ const d=document.createElement('div'); d.className='chip'; d.textContent=`KPI: ${form.kpis.join(' / ')}`; chipsEl.appendChild(d); }
    if(segs.length){ const d=document.createElement('div'); d.className='chip'; d.textContent=`SEG: ${segs.join(', ')}`; chipsEl.appendChild(d); }
  }

  function renderResults(){
    const scored = (window.DB.solutions||[]).map(sol=>{
      const {score,reasons} = scoreSolution(sol, form);
      return {...sol,_score:score,_reasons:reasons};
    }).sort((a,b)=>b._score-a._score);

    if(scored.length){
      leadText.textContent = `入力内容に基づき ${scored.length} 件の候補を見つけました。合致度の高い順に表示しています。`;
      scored.slice(0,8).forEach(sol=>{
        const card=document.createElement('div'); card.className='card';
        const h=document.createElement('h3'); h.innerHTML=`<span class="score">[${sol._score}]</span> ${sol.title}`;
        const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`${sol.provider} / ${sol.service_name} ｜ カテゴリ: ${sol.use_case_category}`;
        const p=document.createElement('p'); p.textContent=sol.description;

        const chips=document.createElement('div'); chips.className='chips';
        sol._reasons.forEach(r=>{ const c=document.createElement('div'); c.className='chip'; c.textContent=r; chips.appendChild(c); });

        const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='10px';
        const btnDemo=document.createElement('button'); btnDemo.className='btn btn-primary'; btnDemo.textContent='デモを見る';
        btnDemo.onclick=()=>openDemo(sol.default_demo_id, sol.title, true);
        const btnDetail=document.createElement('button'); btnDetail.className='btn btn-ghost'; btnDetail.textContent='詳細（シナリオ）';
        btnDetail.onclick=()=>openDemo(sol.default_demo_id, sol.title, true);
        actions.appendChild(btnDemo); actions.appendChild(btnDetail);

        card.appendChild(h); card.appendChild(meta); card.appendChild(p); card.appendChild(chips); card.appendChild(actions);
        grid.appendChild(card);
      });
    }else{
      const demoId = segs.map(s=>DEMO_BY_SEG[s]).find(Boolean) || forceDemoId || null;
      leadText.textContent = demoId ? 'カタログ提案は見つかりませんでしたが、関連デモを表示します。' : '該当するソリューションが見つかりませんでした。';
      if(demoId){
        const info=document.createElement('div'); info.className='empty';
        info.textContent='関連デモを下のビューワに表示しました。';
        grid.appendChild(info);
        openDemo(demoId, '関連デモ', true);
      }else{
        const empty=document.createElement('div'); empty.className='empty'; empty.textContent='該当するソリューションが見つかりませんでした。';
        grid.appendChild(empty);
      }
    }
    if(forceDemoId){ openDemo(forceDemoId, 'プレビュー', true); }
  }

  renderFormChips(); renderResults();

  // ＝＝＝ 地図（拡張） ＝＝＝
  let map, overlayTile, overlayImage, vectorLayers = {};
  const overlayEl = document.getElementById('aiOverlay');

  // UI追加：不透明度スライダー＆メトリクス表示
  const scenarioEl = document.getElementById('scenario');
  const legendEl = document.getElementById('legend');
  const demoActionsEl = document.getElementById('demoActions');

  function addOpacityControl(layerRef, init=0.8){
    // 既存があれば除去
    const old = document.getElementById('opacityCtl');
    if(old) old.remove();
    const wrap = document.createElement('div');
    wrap.id = 'opacityCtl';
    wrap.style.marginTop = '10px';
    wrap.innerHTML = `
      <label style="font-size:12px;color:#9ca3af;">オーバーレイ不透明度</label>
      <input type="range" min="0" max="1" step="0.05" value="${init}" style="width:240px;display:block;margin-top:4px;">
    `;
    legendEl.insertAdjacentElement('afterend', wrap);
    const input = wrap.querySelector('input');
    input.addEventListener('input', ()=>{
      const v = parseFloat(input.value);
      if(layerRef && layerRef.setOpacity) layerRef.setOpacity(v);
      if(overlayImage && overlayImage.setOpacity) overlayImage.setOpacity(v);
    });
  }

  function renderMetrics(metrics){
    // 既存があれば除去
    const old = document.getElementById('metricBar');
    if(old) old.remove();
    if(!Array.isArray(metrics) || metrics.length===0) return;
    const bar = document.createElement('div');
    bar.id = 'metricBar';
    bar.style.display='flex';
    bar.style.flexWrap='wrap';
    bar.style.gap='8px';
    bar.style.marginTop='10px';
    metrics.forEach(m=>{
      const card = document.createElement('div');
      card.className = 'chip';
      card.innerHTML = `<label><strong>${m.value}</strong>｜${m.label}</label>`;
      bar.appendChild(card);
    });
    scenarioEl.insertAdjacentElement('beforebegin', bar);
  }

  async function openDemo(demoId, title, scrollToScenario=false){
    const url = `public/demos/${demoId}/index.json`;
    overlayEl.style.display='flex';
    let meta=null;
    try{ const res=await fetch(url,{cache:'no-store'}); if(res.ok) meta=await res.json(); }catch(e){}
    meta = meta || { title:`${title}（デモ情報未設定）`, last_obs:'', tileUrl:'', center:[35,135], zoom:5, legend:[] };

    // 地域センタリング微調整
    if(/札幌/i.test(form.region)) meta.center=[43.06,141.35];
    if(/北海道/i.test(form.region)) meta.center=[43.22,142.86];
    if(/福岡/i.test(form.region)) meta.center=[33.59,130.40];

    document.getElementById('demoSection').style.display='';
    document.getElementById('demoMeta').textContent =
      `${meta.title}｜最終観測: ${meta.last_obs||'—'}｜提供: ${meta.provider||'—'}｜データ源: ${meta.data_source||meta.data_sources||'—'}`;

    if(!map){
      map = L.map('map');
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
    }
    map.setView(meta.center, meta.zoom||12);

    // 既存オーバーレイをクリア
    if(overlayTile){ overlayTile.remove(); overlayTile=null; }
    if(overlayImage){ overlayImage.remove(); overlayImage=null; }
    Object.values(vectorLayers).forEach(v=>v.remove());
    vectorLayers = {};

    // ベース or タイルオーバーレイ
    if(meta.tileUrl){
      overlayTile = L.tileLayer(meta.tileUrl,{maxZoom:19,opacity:.85}).addTo(map);
    }

    // 画像オーバーレイ（龄級PNGなど）
    if(meta.overlay && meta.overlay.type==='image' && meta.overlay.url && Array.isArray(meta.overlay.bbox)){
      const b = meta.overlay.bbox; // [minX, minY, maxX, maxY]
      const imgBounds = [[b[1], b[0]], [b[3], b[2]]];
      overlayImage = L.imageOverlay(meta.overlay.url, imgBounds, {opacity: meta.overlay.opacity ?? 0.8}).addTo(map);
      addOpacityControl(overlayImage, meta.overlay.opacity ?? 0.8);
    }else if(overlayTile){
      addOpacityControl(overlayTile, 0.85);
    }

    // ベクターレイヤ読込（任意）
    if(Array.isArray(meta.layers)){
      for(const lyr of meta.layers){
        if(lyr.type==='geojson' && lyr.url){
          try{
            const res = await fetch(lyr.url, {cache:'no-store'});
            if(res.ok){
              const gj = await res.json();
              const style = lyr.style || {color:'#22d3ee',weight:1,opacity:.6,fillOpacity:0.0};
              vectorLayers[lyr.id] = L.geoJSON(gj,{style}).addTo(map);
            }
          }catch(e){}
        }
      }
    }

    // 凡例
    const legend = document.getElementById('legend'); legend.innerHTML='';
    (meta.legend||[]).forEach(it=>{
      const d=document.createElement('div'); d.className='item';
      const sw=document.createElement('span'); sw.className='sw';
      sw.style.background = it.color || '#334155';
      sw.textContent = it.icon || '';
      const t=document.createElement('span'); t.textContent=it.label||''; d.appendChild(sw); d.appendChild(t);
      legend.appendChild(d);
    });

    // メトリクス（新）
    renderMetrics(meta.metrics);

    // シナリオ＋CTA
    scenarioEl.textContent = meta.scenario || meta.scenario_text || 'このデモの活用ストーリーは準備中です。';
    demoActionsEl.innerHTML='';
    const btnLocal=document.createElement('button'); btnLocal.className='btn btn-primary';
    btnLocal.textContent='自分の地域でも試せますか？';
    btnLocal.onclick=()=> window.open((meta.cta?.href || 'mailto:contact@example.com?subject=デモ相談&body=地域: '+(form.region||'')), '_blank','noopener');
    demoActionsEl.appendChild(btnLocal);
    if(meta.cta && meta.cta.href){
      const btn=document.createElement('a'); btn.className='btn btn-ghost'; btn.textContent=meta.cta.text||'相談する';
      btn.href=meta.cta.href; btn.target='_blank'; btn.rel='noopener';
      demoActionsEl.appendChild(btn);
    }

    overlayEl.style.display='none';
    if(scrollToScenario) scenarioEl.scrollIntoView({behavior:'smooth',block:'nearest'});
  }
</script>
