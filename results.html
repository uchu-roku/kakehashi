<script>
document.addEventListener('DOMContentLoaded', () => {
  // ========== 入力の復元 ==========
  const chipsEl   = document.getElementById('formChips');
  const grid      = document.getElementById('resultsGrid');
  const leadText  = document.getElementById('leadText');
  const scenarioEl = document.getElementById('scenario');
  const demoActionsEl = document.getElementById('demoActions');
  const demoMetaEl = document.getElementById('demoMeta');
  const docEl = document.getElementById('docViewer');
  const creditEl = document.getElementById('creditNote');

  const params = new URLSearchParams(location.search);
  const lastForm = JSON.parse(localStorage.getItem('kakehashi:lastForm')||'{}');
  const form = {
    industry: params.get('industry') || lastForm.industry || '',
    region  : params.get('region')   || lastForm.region   || '',
    problem : params.get('problem')  || lastForm.problem  || '',
    kpis    : (params.get('kpi')||'').split(',').filter(Boolean)
  };
  const forceDemoId = params.get('demo_id') || '';

  // ========== 軽量ユーティリティ ==========
  const esc = s => (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const md = (s='') => esc(s).replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/^-\s(.+)$/gm,'<li>$1</li>').replace(/(<li>.*<\/li>)/gs,'<ul>$1</ul>').replace(/\n/g,'<br>');
  const tokens = (s='') => (s.toLowerCase().normalize('NFKC').match(/[\p{Letter}\p{Number}_]+/ug)||[]);
  const jaccard = (a,b) => { const A=new Set(a),B=new Set(b); const inter=[...A].filter(x=>B.has(x)).length; const uni=new Set([...A,...B]).size; return uni? inter/uni : 0; };

  // ========== スコアリング（関連度） ==========
  function scoreDemo(demo, form){
    let score = 0; const reasons = [];

    // 1) 業界カテゴリ一致（例：林業/災害/農業…）
    const indKey = (form.industry||'').split('/')[0]; // 「インフラ点検/建設」→「インフラ点検」
    if(indKey && demo.category && demo.category.includes(indKey)){ score += 3; reasons.push('業界一致'); }

    // 2) 問題文とのテキスト類似
    const textDemo = [demo.title, demo.summary, demo.category, (demo.tags||[]).join(' ')].join(' ');
    const sim = jaccard(tokens(form.problem||''), tokens(textDemo));
    const simPts = Math.round(sim * 4); // 0〜4点
    if(simPts>0){ score += simPts; reasons.push(`課題類似${(sim*100).toFixed(0)}%`); }

    // 3) KPI の重なり
    const kForm = new Set(form.kpis||[]);
    const kDemo = new Set(demo.kpis||[]);
    const kHit = [...kForm].filter(k=>kDemo.has(k)).length;
    if(kHit>0){ score += kHit*2; reasons.push(`KPI一致×${kHit}`); }

    // 4) キーワード直ヒット（タイトル/タグ/要約）
    const prob = (form.problem||'').toLowerCase();
    const kw = ['洪水','浸水','赤潮','メタン','森林','NDVI','圃場','養殖','保険','災害','排出','フレア'];
    const demoKw = (textDemo||'').toLowerCase();
    const kwHits = kw.filter(k=> prob.includes(k.toLowerCase()) && demoKw.includes(k.toLowerCase())).length;
    if(kwHits>0){ score += kwHits; reasons.push(`キーワード一致×${kwHits}`); }

    return { score, reasons };
  }

  // ========== デモ描画 ==========
  function renderDoc(demo){
    if(!demo){ docEl.innerHTML = '<div class="note">デモ未選択</div>'; return; }

    demoMetaEl.textContent = `${demo.title}｜カテゴリ: ${demo.category||'—'}｜データ源: ${(demo.data_sources||[]).join('/')}｜最終観測: ${demo.last_obs||'—'}`;

    const bullets = (demo.bullets||[]).map(x=>`<li>${esc(x)}</li>`).join('');
    const steps = (demo.steps||[]).map(st=>`<h3>■ ${esc(st.title)}</h3><div>${md(st.body_md||'')}</div>`).join('');
    const kpis = (demo.kpis||[]).map(k=>`<span class="chip" style="margin-right:6px">${esc(k)}</span>`).join('');

    docEl.innerHTML = `
      <h3 style="margin-top:0">${esc(demo.title)}</h3>
      <div style="color:#9ca3af;margin:6px 0">${esc(demo.summary||'—')}</div>
      ${bullets?`<ul style="margin-top:8px">${bullets}</ul>`:''}
      <div style="margin-top:10px">${steps}</div>
      ${kpis?`<div style="margin-top:12px">${kpis}</div>`:''}
    `;

    // 出典
    if(demo.credit && demo.credit.href){
      creditEl.innerHTML = `出典: <a href="${demo.credit.href}" target="_blank" rel="noopener">${esc(demo.credit.label||demo.credit.href)}</a>`;
      creditEl.style.display = 'block';
    }else{
      creditEl.style.display = 'none';
      creditEl.innerHTML = '';
    }

    // CTA
    demoActionsEl.innerHTML = '';
    if(demo.cta && demo.cta.href){
      const a = document.createElement('a');
      a.className='btn btn-primary';
      a.href = demo.cta.href; a.target='_blank'; a.rel='noopener';
      a.textContent = demo.cta.label || '相談する';
      demoActionsEl.appendChild(a);
    }
  }

  function renderResults(demos, filtered){
    grid.innerHTML = '';
    const list = filtered ?? demos;

    leadText.textContent = `関連デモ ${list.length} 件を表示中${filtered ? '' : '（全件）' }。`;

    if(list.length===0){
      grid.innerHTML = `
        <div class="result-card">
          <h3>該当するデモが見つかりませんでした</h3>
          <p class="meta">入力を広げるか、全件を表示してください。</p>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button class="btn btn-ghost" id="showAll">全件を表示</button>
          </div>
        </div>`;
      document.getElementById('showAll')?.addEventListener('click', ()=> renderResults(demos, null));
      return;
    }

    list.forEach(demo=>{
      const card = document.createElement('div'); card.className='result-card';
      const h=document.createElement('h3'); h.innerHTML= esc(demo.title);
      const meta=document.createElement('div'); meta.className='meta';
      meta.textContent = `カテゴリ: ${demo.category||'—'} ｜ タグ: ${(demo.tags||[]).join(', ')}`;
      const p=document.createElement('p'); p.textContent = demo.summary||'—';

      const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='8px';
      const btn=document.createElement('button'); btn.className='btn btn-primary'; btn.textContent='デモを見る';
      btn.onclick=()=> openDemoDoc(demo.id);
      actions.appendChild(btn);

      card.appendChild(h); card.appendChild(meta); card.appendChild(p); card.appendChild(actions);
      grid.appendChild(card);
    });
  }

  function openDemoDoc(id){
    const d = DEMOS.find(x=>x.id===id);
    renderDoc(d);
    scenarioEl.textContent = d?.scenario || '（MVP：文章でのシナリオ記述）';
    const q = new URLSearchParams(location.search); q.set('demo_id', id);
    history.replaceState(null, '', location.pathname+'?'+q.toString());
  }

  // ========== 起動：demos.json を読み込み → スコアリングしてフィルタ ==========
  let DEMOS = [];
  fetch('public/demos/demos.json', {cache:'no-store'})
    .then(r=>r.json())
    .then(json=>{
      DEMOS = json.demos||[];

      // 1) スコア計算
      const scored = DEMOS.map(d => ({ demo:d, ...scoreDemo(d, form) }))
                          .sort((a,b)=> b.score - a.score);

      // 2) 閾値でフィルタ（2点以上を関連とみなす）
      const THRESHOLD = 2;
      const related = scored.filter(s=> s.score >= THRESHOLD).map(s=> s.demo);

      // 3) 表示
      renderResults(DEMOS, related);

      // 4) 初期選択：forceDemoId → 一番スコア高い関連 → 先頭
      const initial = forceDemoId ||
                      (related[0]?.id) ||
                      (DEMOS[0]?.id);
      if(initial) openDemoDoc(initial);

      // 5) フォームチップ復元
      chipsEl.innerHTML = '';
      if(form.industry){ const d=document.createElement('div'); d.className='chip'; d.textContent='業界: '+form.industry; chipsEl.appendChild(d); }
      if(form.region){   const d=document.createElement('div'); d.className='chip'; d.textContent='地域: '+form.region; chipsEl.appendChild(d); }
      if(Array.isArray(form.kpis)&&form.kpis.length){ const d=document.createElement('div'); d.className='chip'; d.textContent='KPI: '+form.kpis.join(' / '); chipsEl.appendChild(d); }
      if(form.problem){  const d=document.createElement('div'); d.className='chip'; d.textContent='課題: '+(form.problem.length>22? form.problem.slice(0,22)+'…' : form.problem); chipsEl.appendChild(d); }
    })
    .catch(()=>{
      docEl.innerHTML='<div class="note">demos.json の読込に失敗しました。</div>';
      renderResults([], []); // 空でもUIは表示
    });
});
</script>
