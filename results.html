<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KAKEHASHI デモ | 診断結果 (cases v1.5)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#0b1020; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af;
    --chip:#0b1326; --chipb:#2a3953; --accent:#22d3ee; --accent2:#a78bfa;
    --line:#243045;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 600px at 80% -10%, rgba(167,139,250,.25), transparent),var(--bg);color:var(--text);font-family:Inter,system-ui,"Noto Sans JP",sans-serif}
  header{padding:20px 24px;border-bottom:1px solid #1f2937;position:sticky;top:0;background:linear-gradient(180deg,rgba(17,24,39,.9),rgba(17,24,39,.7));backdrop-filter:blur(6px);z-index:10}
  .wrap{max-width:1200px;margin:0 auto;padding:20px 24px}
  h1{margin:0 0 8px;font-size:24px}
  .grid{display:grid;grid-template-columns:1.12fr .88fr;gap:18px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,rgba(31,41,55,.75),rgba(17,24,39,.9));border:1px solid var(--line);border-radius:14px;padding:16px}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .chip{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--chipb);background:var(--chip);font-size:12px;color:#cbd5e1}
  .results-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:0 0 10px}
  .cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
  @media (max-width:980px){.cards{grid-template-columns:1fr}}
  .result-card{background:linear-gradient(180deg,rgba(31,41,55,.75),rgba(17,24,39,.9));border:1px solid var(--line);border-radius:14px;padding:14px}
  .result-title{margin:0 0 6px;font-size:16px}
  .result-meta{font-size:12px;color:#9ca3af;display:flex;gap:8px;flex-wrap:wrap}
  .result-desc{margin:8px 0 10px;color:#cbd5e1;font-size:14px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--chipb);background:var(--chip);color:#cbd5e1;font-size:12px}
  .score{border-color:#1f3b56;background:#0b1a2a;color:#93c5fd}
  .step{margin:8px 0;color:#cbd5e1;font-size:14px}
  .btn{appearance:none;border:none;cursor:pointer;font-weight:700;padding:8px 12px;border-radius:10px}
  .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0b1020}
</style>
</head>
<body>
<header class="wrap" style="padding-top:14px;padding-bottom:14px">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
    <h1 style="margin:0">診断結果</h1>
    <a href="./" class="chip" style="text-decoration:none">← 入力に戻る</a>
  </div>
</header>

<main class="wrap">
  <p id="lead" style="color:#9ca3af;margin:0 0 10px">あなたの入力に基づき、関連するケースを提示します。</p>
  <div id="chips" class="chips"></div>

  <div class="grid">
    <section class="card">
      <div id="list"></div>
    </section>
    <section class="card">
      <h2 style="margin:0 0 6px;font-size:18px">ケース詳細</h2>
      <div id="meta" style="font-size:12px;color:#9ca3af;margin-bottom:6px">未選択</div>
      <div id="detail" style="background:#0b1326;border:1px solid #243045;border-radius:12px;padding:14px;min-height:360px"></div>
      <div id="cta" style="display:flex;gap:8px;margin-top:10px"></div>
    </section>
  </div>
</main>

<footer style="color:#6b7280;text-align:center;font-size:12px;padding:24px;">© 2025 KAKEHASHI Project – Prototype</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const chips = document.getElementById('chips');
  const list  = document.getElementById('list');
  const meta  = document.getElementById('meta');
  const detail= document.getElementById('detail');
  const cta   = document.getElementById('cta');
  const lead  = document.getElementById('lead');

  const qs = new URLSearchParams(location.search);
  const form = {
    industry: qs.get('industry')||'',
    q:        qs.get('q')||'',
    needs:    (qs.get('need')||'').split(',').filter(Boolean),
    kpis:     (qs.get('kpi')||'').split(',').filter(Boolean),
    region:   qs.get('region')||''
  };

  function esc(s=''){ return s.replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\\'':'&#39;'}[c])); }
  function chip(text){ const span=document.createElement('span'); span.className='chip'; span.textContent=text; chips.appendChild(span); }
  if(form.industry) chip('業界: '+form.industry);
  if(form.region)   chip('地域: '+form.region);
  if(form.needs.length) chip('課題: '+form.needs.join(' / '));
  if(form.kpis.length)  chip('KPI: '+form.kpis.join(' / '));
  if(form.q)        chip('自由記述あり');

  function tokenize(s=''){ return s.toLowerCase().replace(/[Ａ-Ｚａ-ｚ０-９]/g, ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0)).split(/[^\p{Letter}\p{Number}]+/u).filter(Boolean); }
  function jaccard(a,b){ const A=new Set(a),B=new Set(b); const inter=[...A].filter(x=>B.has(x)).length; const uni=new Set([...A,...B]).size; return uni?inter/uni:0; }

  function score(c){
    let s=0, reasons=[];
    if(form.industry && c.industry===form.industry){ s+=3; reasons.push('業界一致'); }
    if(form.needs.length && form.needs.includes(c.business_need)){ s+=3; reasons.push('課題一致'); }
    if(form.kpis.length && form.kpis.some(k => (c.kpi||'').includes(k))){ s+=1; reasons.push('KPI含有'); }
    if(form.q){
      const sim = jaccard(tokenize(form.q), tokenize([c.problem,c.solution,c.kpi,c.reference].join(' ')));
      const pts = Math.min(3, Math.round(sim*4)); if(pts>0){ s+=pts; reasons.push(`文章類似 ${(sim*100|0)}%`); }
    }
    return {score:s, reasons};
  }

  function renderDetail(c){
    if(!c){ meta.textContent='未選択'; detail.innerHTML='<div class="step" style="color:#9ca3af">左のカードから選択してください。</div>'; cta.innerHTML=''; return; }
    meta.textContent = `${c.industry} × ${c.business_need}`;
    detail.innerHTML = `
      <div class="step"><b>■ 課題</b><div>${esc(c.problem||'—')}</div></div>
      <div class="step"><b>■ 解決アプローチ</b><div>${esc(c.solution||'—')}</div></div>
      ${c.kpi ? `<div class="step"><b>■ KPI</b><div>${esc(c.kpi)}</div></div>` : ''}
      ${c.reference ? `<div class="step"><b>■ 参考</b><div>${esc(c.reference)}</div></div>` : ''}
    `;
    cta.innerHTML = '';
    if(c.cta){
      const a=document.createElement('a');
      a.className='btn btn-primary'; a.target='_blank'; a.rel='noopener';
      if(typeof c.cta==='string'){ a.href='#'; a.textContent=c.cta; }
      else { a.href=c.cta.href||'#'; a.textContent=c.cta.label||'相談する'; }
      cta.appendChild(a);
    }
  }

  function render(listData){
    list.innerHTML = `
      <div class="results-header">
        <h2 style="margin:0;font-size:18px">該当ケース</h2>
        <span style="color:#9ca3af;font-size:12px">表示件数: ${listData.length}</span>
      </div>
      <div class="cards" id="cards"></div>
    `;
    const cards=document.getElementById('cards');
    if(listData.length===0){ lead.textContent='条件に合致するケースがありませんでした。'; renderDetail(null); return; }
    lead.textContent = `ケース ${listData.length} 件を表示（入力に基づく抽出）`;

    listData.forEach(c=>{
      const reasons = (c._rank?.reasons||[]).map(r=>`<span class="badge">${esc(r)}</span>`).join('');
      const html = `
        <article class="result-card">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <h3 class="result-title">${esc(c.industry)} × ${esc(c.business_need)}</h3>
            ${c._rank ? `<span class="badge score">合致度: ${c._rank.score}</span>` : ''}
          </div>
          <div class="result-meta">
            ${c.kpi ? `<span>KPI: ${esc(c.kpi)}</span>`:''}
            ${c.reference ? `<span>参考: ${esc(c.reference)}</span>`:''}
          </div>
          <p class="result-desc"><b>課題:</b> ${esc(c.problem||'—')}</p>
          <p class="result-desc"><b>解決:</b> ${esc(c.solution||'—')}</p>
          ${reasons ? `<div class="chips" style="margin-top:8px">${reasons}</div>`:''}
          <div style="margin-top:10px">
            <button class="btn btn-primary">詳細を見る</button>
          </div>
        </article>
      `;
      const wrap=document.createElement('div'); wrap.innerHTML=html;
      const card=wrap.firstElementChild;
      card.querySelector('.btn-primary').addEventListener('click', ()=>openCase(c.id));
      cards.appendChild(card);
    });
    // 初期選択（case_id がURLにあればそれを優先）
    const initialId = qs.get('case_id') || (listData[0] && listData[0].id);
    if(initialId) openCase(initialId);
  }

  function openCase(id){
    const c = CASES.find(x=>String(x.id)===String(id));
    if(!c) return;
    renderDetail(c);
    const q=new URLSearchParams(location.search); q.set('case_id', id); history.replaceState(null,'',location.pathname+'?'+q.toString());
  }

  let CASES=[];

  fetch('cases-db.json',{cache:'no-store'}).then(r=>{
    if(!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }).then(json=>{
    CASES = Array.isArray(json)?json:(json.cases||[]);

    const base = CASES.filter(c=>{
      const okInd = !form.industry || c.industry===form.industry;
      const okNeed= !form.needs.length || form.needs.includes(c.business_need);
      const okKw  = !form.q || [c.problem,c.solution,c.kpi,c.reference].some(v => (v||'').toLowerCase().includes(form.q.toLowerCase()));
      const okKpi = !form.kpis.length || form.kpis.some(k => (c.kpi||'').includes(k));
      return okInd && okNeed && okKw && okKpi;
    }).map(c=>({ ...c, _rank: score(c) }))
      .filter(x=>x._rank.score>0)
      .sort((a,b)=>b._rank.score-a._rank.score);

    render(base);
  }).catch(err=>{
    detail.innerHTML = '<div class="step">cases-db.json の読込に失敗しました。index.html と同じ階層に配置し、パスを合わせてください。<br>エラー: '+esc(err.message)+'</div>';
  });
});
</script>
</body>
</html>
