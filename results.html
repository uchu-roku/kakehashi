<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KAKEHASHI デモ | 診断結果 (Card UI)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#0b1020; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af;
    --chip:#0b1326; --chipb:#2a3953; --accent:#22d3ee; --accent2:#a78bfa;
    --ok:#16a34a; --warn:#f59e0b; --line:#243045;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 600px at 80% -10%, rgba(167,139,250,.25), transparent),var(--bg);color:var(--text);font-family:Inter,system-ui,"Noto Sans JP",sans-serif}
  header{padding:20px 24px;border-bottom:1px solid #1f2937;position:sticky;top:0;background:linear-gradient(180deg,rgba(17,24,39,.9),rgba(17,24,39,.7));backdrop-filter:blur(6px);z-index:10}
  .wrap{max-width:1200px;margin:0 auto;padding:20px 24px}
  h1{margin:0 0 8px;font-size:24px}
  .lead{color:var(--muted);margin:0 0 16px}
  .grid{display:grid;grid-template-columns:1.12fr .88fr;gap:18px}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

  .card{background:linear-gradient(180deg,rgba(31,41,55,.75),rgba(17,24,39,.9));border:1px solid var(--line);border-radius:14px;padding:16px}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .chip{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--chipb);background:var(--chip);font-size:12px;color:#cbd5e1}

  /* ===== Card UI for results ===== */
  .results-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:0 0 10px}
  .results-count{color:var(--muted);font-size:12px}
  .cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
  @media (max-width: 980px){ .cards{grid-template-columns:1fr} }

  .result-card{background:linear-gradient(180deg,rgba(31,41,55,.75),rgba(17,24,39,.9));border:1px solid var(--line);border-radius:14px;padding:14px}
  .result-title{margin:0 0 6px;font-size:16px}
  .result-meta{font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}
  .result-desc{margin:8px 0 10px;color:#cbd5e1;font-size:14px}

  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--chipb);background:var(--chip);color:#cbd5e1;font-size:12px}
  .score-badge{border-color:#1f3b56;background:#0b1a2a;color:#93c5fd}
  .reason-chips{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0 4px}
  .kpi-wrap{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .kpi{background:#0d1b2a;border:1px solid #204060;color:#cdeafe}

  .card-actions{display:flex;align-items:center;gap:8px;margin-top:10px}
  .btn{appearance:none;border:none;cursor:pointer;font-weight:700;padding:8px 12px;border-radius:10px}
  .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0b1020}
  .btn-ghost{background:transparent;color:#cbd5e1;border:1px solid var(--chipb)}

  /* 折りたたみ詳細 */
  details{border-top:1px dashed var(--line);margin-top:10px;padding-top:8px}
  details summary{list-style:none;cursor:pointer;color:#cbd5e1;font-size:13px;display:flex;align-items:center;gap:6px}
  details summary::marker{display:none}
  details[open] summary .caret{transform:rotate(90deg)}
  .caret{transition:transform .15s ease;display:inline-block}
  .step{margin:8px 0;color:#cbd5e1;font-size:14px}
  .step h4{margin:0 0 4px;font-size:14px}
</style>
</head>
<body>
<header class="wrap" style="padding-top:14px;padding-bottom:14px">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
    <h1 style="margin:0">診断結果</h1>
    <a href="./" class="chip" style="text-decoration:none">← 入力に戻る</a>
  </div>
</header>

<main class="wrap">
  <p class="lead" id="leadText">あなたの入力に基づき、関連するケース（100件DB）を提示します。</p>

  <div class="chips" id="formChips"></div>

  <div class="grid">
    <!-- 左：カード型の候補一覧 -->
    <section class="card">
      <div id="resultsGrid"></div>
    </section>

    <!-- 右：ケース詳細ビュー -->
    <section class="card" style="position:relative">
      <h2 style="margin:0 0 6px;font-size:18px">ケース詳細</h2>
      <div id="caseMeta" style="font-size:12px;color:#9ca3af;margin-bottom:6px">未選択</div>

      <div id="docViewer" style="background:#0b1326;border:1px solid #243045;border-radius:12px;padding:14px;min-height:360px"></div>
      <div id="ctaArea" style="display:flex;gap:8px;margin-top:10px"></div>
    </section>
  </div>
</main>

<footer style="color:#6b7280;text-align:center;font-size:12px;padding:24px;">© 2025 KAKEHASHI Project – Prototype</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ---------- DOM ----------
  const chipsEl      = document.getElementById('formChips');
  const grid         = document.getElementById('resultsGrid');
  const leadText     = document.getElementById('leadText');
  const caseMetaEl   = document.getElementById('caseMeta');
  const docEl        = document.getElementById('docViewer');
  const ctaEl        = document.getElementById('ctaArea');

  if (!grid || !docEl) return;

  // ---------- 入力の復元（URL優先） ----------
  const urlParams = new URLSearchParams(location.search);
  const form = {
    industry: urlParams.get('industry') || '',
    need    : urlParams.get('need')     || '',
    q       : urlParams.get('q')        || '',
    kpi     : urlParams.get('kpi')      || ''
  };

  // 入力チップ
  chipsEl.innerHTML = '';
  if(form.industry){ chipsEl.insertAdjacentHTML('beforeend', `<div class="chip">業界: ${escapeHtml(form.industry)}</div>`); }
  if(form.need){     chipsEl.insertAdjacentHTML('beforeend', `<div class="chip">課題: ${escapeHtml(form.need)}</div>`); }
  if(form.kpi){      chipsEl.insertAdjacentHTML('beforeend', `<div class="chip">KPI: ${escapeHtml(form.kpi)}</div>`); }
  if(form.q){        chipsEl.insertAdjacentHTML('beforeend', `<div class="chip">自由記述あり</div>`); }

  // ---------- Utils ----------
  function escapeHtml(s=''){
    return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  const tokenize = (s='') =>
    s.toLowerCase()
     .replace(/[Ａ-Ｚａ-ｚ０-９]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0xFEE0))
     .split(/[^\p{Letter}\p{Number}]+/u).filter(Boolean);
  const jaccard = (a,b) => {
    const A=new Set(a), B=new Set(b);
    const inter=[...A].filter(x=>B.has(x)).length;
    const uni  =new Set([...A,...B]).size;
    return uni ? inter/uni : 0;
  };

  function rankCases(cases, form){
    const kw = (form.q||'').trim();
    const kwTokens = tokenize(kw);

    return cases.map(c => {
      let score = 0; const reasons = [];

      if (form.industry && c.industry === form.industry){ score += 3; reasons.push('業界一致'); }
      if (form.need && c.business_need === form.need){ score += 3; reasons.push('課題カテゴリ一致'); }

      if (kw){
        const text = [c.problem, c.solution, c.kpi, c.reference].join(' ');
        const sim = jaccard(kwTokens, tokenize(text));
        const pts = Math.min(3, Math.round(sim*4)); // up to +3
        if (pts>0){ score += pts; reasons.push(`文章類似 ${(sim*100|0)}%`); }
      }

      if (form.kpi){
        const k = (c.kpi||'').toLowerCase();
        if (k.includes(form.kpi.toLowerCase())){ score += 1; reasons.push('KPI含有'); }
      }

      return {...c, _rank:{score, reasons}};
    })
    .filter(x => x._rank.score > 0)
    .sort((a,b) => b._rank.score - a._rank.score);
  }

  function renderDetail(c){
    if(!c){
      caseMetaEl.textContent = '未選択';
      docEl.innerHTML = '<div class="step" style="color:#9ca3af">左のカードから選択してください。</div>';
      ctaEl.innerHTML = '';
      return;
    }
    caseMetaEl.textContent = `${c.industry} × ${c.business_need}`;
    const ref = c.reference ? `<div class="step"><h4>■ 参考</h4><div>${escapeHtml(c.reference)}</div></div>` : '';
    const kpi = c.kpi ? `<div class="step"><h4>■ KPI</h4><div>${escapeHtml(c.kpi)}</div></div>` : '';

    docEl.innerHTML = `
      <div class="step"><h4>■ 課題</h4><div>${escapeHtml(c.problem||'—')}</div></div>
      <div class="step"><h4>■ 解決アプローチ</h4><div>${escapeHtml(c.solution||'—')}</div></div>
      ${kpi}
      ${ref}
    `;

    ctaEl.innerHTML = '';
    if (c.cta){
      const a = document.createElement('a');
      a.className = 'btn btn-primary';
      a.href = typeof c.cta === 'string' ? '#' : (c.cta.href || '#');
      a.target = '_blank';
      a.rel = 'noopener';
      a.textContent = typeof c.cta === 'string' ? c.cta : (c.cta.label || '相談する');
      ctaEl.appendChild(a);
    }
  }

  function renderResults(list){
    grid.innerHTML = `
      <div class="results-header">
        <h2 style="margin:0;font-size:18px">該当ケース</h2>
        <span class="results-count">表示件数: ${list.length}</span>
      </div>
      <div class="cards" id="cards"></div>
    `;
    const cards = document.getElementById('cards');

    if (list.length === 0){
      leadText.textContent = '入力内容に合致するケースは見つかりませんでした。条件を広げてお試しください。';
      cards.insertAdjacentHTML('beforeend',
        `<div class="result-card"><p class="result-desc" style="margin:0">該当する候補がありません。</p></div>`);
      renderDetail(null);
      return;
    }

    leadText.textContent = `ケース ${list.length} 件を表示（入力内容に基づき抽出）`;

    list.forEach(c=>{
      const reasons = (c._rank?.reasons||[]).map(r=>`<span class="badge">${escapeHtml(r)}</span>`).join('');

      const html = `
        <article class="result-card">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <h3 class="result-title">${escapeHtml(c.industry)} × ${escapeHtml(c.business_need)}</h3>
            ${c._rank ? `<span class="badge score-badge">合致度: ${c._rank.score}</span>` : ''}
          </div>

          <div class="result-meta">
            ${c.kpi ? `<span>KPI目安: ${escapeHtml(c.kpi)}</span>` : ''}
            ${c.reference ? `<span>参考: ${escapeHtml(c.reference)}</span>` : ''}
          </div>

          <p class="result-desc"><b>課題:</b> ${escapeHtml(c.problem||'—')}</p>
          <p class="result-desc"><b>解決:</b> ${escapeHtml(c.solution||'—')}</p>

          ${reasons ? `<div class="reason-chips">${reasons}</div>` : ''}

          <div class="card-actions">
            <button class="btn btn-primary">詳細を見る</button>
          </div>
        </article>
      `;

      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      const cardEl = wrapper.firstElementChild;

      cardEl.querySelector('.btn.btn-primary').addEventListener('click', ()=> openCase(c.id));

      cards.appendChild(cardEl);
    });

    // 初期選択
    openCase(list[0].id);
  }

  function openCase(id){
    const c = _CASES.find(x=>x.id===id);
    renderDetail(c);
    const q = new URLSearchParams(location.search); q.set('case_id', id);
    history.replaceState(null, '', location.pathname+'?'+q.toString());
  }

  let _CASES = [];

  // ---------- 起動：cases-db.json 読込 → 抽出 → 描画 ----------
  fetch('cases-db.json', {cache:'no-store'})
    .then(r=>r.json())
    .then(json=>{
      _CASES = Array.isArray(json) ? json : (json.cases||[]);

      // フィルタ前の予備絞り込み（industry/need/q）
      const base = _CASES.filter(c => {
        const okInd  = !form.industry || c.industry === form.industry;
        const okNeed = !form.need     || c.business_need === form.need;
        const kw = (form.q||'').trim().toLowerCase();
        const okKw = !kw || [c.problem,c.solution,c.kpi,c.reference].some(v => (v||'').toLowerCase().includes(kw));
        return okInd && okNeed && okKw;
      });

      const ranked = rankCases(base, form);
      renderResults(ranked);
    })
    .catch(err=>{
      console.error(err);
      docEl.innerHTML='<div class="step">cases-db.json の読込に失敗しました。配置パスをご確認ください。</div>';
    });
});
</script>
</body>
</html>
