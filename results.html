<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KAKEHASHI ãƒ‡ãƒ¢ | è¨ºæ–­çµæœ (Card UI)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#0b1020; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af;
    --chip:#0b1326; --chipb:#2a3953; --accent:#22d3ee; --accent2:#a78bfa;
    --ok:#16a34a; --warn:#f59e0b; --line:#243045;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 600px at 80% -10%, rgba(167,139,250,.25), transparent),var(--bg);color:var(--text);font-family:Inter,system-ui,"Noto Sans JP",sans-serif}
  header{padding:20px 24px;border-bottom:1px solid #1f2937;position:sticky;top:0;background:linear-gradient(180deg,rgba(17,24,39,.9),rgba(17,24,39,.7));backdrop-filter:blur(6px);z-index:10}
  .wrap{max-width:1200px;margin:0 auto;padding:20px 24px}
  h1{margin:0 0 8px;font-size:24px}
  .lead{color:var(--muted);margin:0 0 16px}
  .grid{display:grid;grid-template-columns:1.12fr .88fr;gap:18px}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

  .card{background:linear-gradient(180deg,rgba(31,41,55,.75),rgba(17,24,39,.9));border:1px solid var(--line);border-radius:14px;padding:16px}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .chip{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--chipb);background:var(--chip);font-size:12px;color:#cbd5e1}

  /* ===== Card UI for results ===== */
  .results-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:0 0 10px}
  .results-count{color:var(--muted);font-size:12px}
  .cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
  @media (max-width: 980px){ .cards{grid-template-columns:1fr} }

  .result-card{background:linear-gradient(180deg,rgba(31,41,55,.75),rgba(17,24,39,.9));border:1px solid var(--line);border-radius:14px;padding:14px}
  .result-title{margin:0 0 6px;font-size:16px}
  .result-meta{font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}
  .result-desc{margin:8px 0 10px;color:#cbd5e1;font-size:14px}

  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--chipb);background:var(--chip);color:#cbd5e1;font-size:12px}
  .score-badge{border-color:#1f3b56;background:#0b1a2a;color:#93c5fd}
  .reason-chips{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0 4px}
  .kpi-wrap{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .kpi{background:#0d1b2a;border:1px solid #204060;color:#cdeafe}

  .card-actions{display:flex;align-items:center;gap:8px;margin-top:10px}
  .btn{appearance:none;border:none;cursor:pointer;font-weight:700;padding:8px 12px;border-radius:10px}
  .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0b1020}
  .btn-ghost{background:transparent;color:#cbd5e1;border:1px solid var(--chipb)}

  /* æŠ˜ã‚ŠãŸãŸã¿è©³ç´° */
  details{border-top:1px dashed var(--line);margin-top:10px;padding-top:8px}
  details summary{list-style:none;cursor:pointer;color:#cbd5e1;font-size:13px;display:flex;align-items:center;gap:6px}
  details summary::marker{display:none}
  details[open] summary .caret{transform:rotate(90deg)}
  .caret{transition:transform .15s ease;display:inline-block}
  .step{margin:8px 0;color:#cbd5e1;font-size:14px}
  .step h4{margin:0 0 4px;font-size:14px}
</style>
</head>
<body>
<header class="wrap" style="padding-top:14px;padding-bottom:14px">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
    <h1 style="margin:0">è¨ºæ–­çµæœ</h1>
    <a href="./" class="chip" style="text-decoration:none">â† å…¥åŠ›ã«æˆ»ã‚‹</a>
  </div>
</header>

<main class="wrap">
  <p class="lead" id="leadText">ã‚ãªãŸã®å…¥åŠ›ã«åŸºã¥ãã€é–¢é€£ã™ã‚‹ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³å€™è£œã‚’æç¤ºã—ã¾ã™ã€‚</p>

  <div class="chips" id="formChips"></div>

  <div class="grid">
    <!-- å·¦ï¼šã‚«ãƒ¼ãƒ‰å‹ã®å€™è£œä¸€è¦§ -->
    <section class="card">
      <div id="resultsGrid"></div>
    </section>

    <!-- å³ï¼šãƒ‡ãƒ¢ãƒ“ãƒ¥ãƒ¼ãƒ¯ï¼ˆæ–‡æ›¸MVPï¼‰ -->
    <section class="card" style="position:relative">
      <h2 style="margin:0 0 6px;font-size:18px">ãƒ‡ãƒ¢ãƒ“ãƒ¥ãƒ¼ãƒ¯</h2>
      <div id="demoMeta" style="font-size:12px;color:#9ca3af;margin-bottom:6px">ãƒ‡ãƒ¢æœªé¸æŠ</div>

      <div id="docViewer" style="background:#0b1326;border:1px solid #243045;border-radius:12px;padding:14px;min-height:360px"></div>
      <div id="creditNote" class="note" style="display:none;font-size:11px;color:#9ca3af;margin-top:6px"></div>

      <div id="legend" style="margin-top:10px"></div>
      <p id="scenario" style="margin-top:10px;color:#cbd5e1;font-size:14px">ã“ã“ã«ãƒ‡ãƒ¢ã®æ´»ç”¨ã‚·ãƒŠãƒªã‚ªãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
      <div id="demoActions" style="display:flex;gap:8px;margin-top:6px"></div>
    </section>
  </div>
</main>

<footer style="color:#6b7280;text-align:center;font-size:12px;padding:24px;">Â© 2025 KAKEHASHI Project â€“ Prototype</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ---------- DOM ----------
  const chipsEl      = document.getElementById('formChips');
  const grid         = document.getElementById('resultsGrid');
  const leadText     = document.getElementById('leadText');
  const scenarioEl   = document.getElementById('scenario');
  const demoActionsEl= document.getElementById('demoActions');
  const demoMetaEl   = document.getElementById('demoMeta');
  const docEl        = document.getElementById('docViewer');
  const creditEl     = document.getElementById('creditNote');

  if (!grid || !docEl) return;

  // ---------- å…¥åŠ›ã®å¾©å…ƒï¼ˆURLå„ªå…ˆ â†’ localStorageï¼‰ ----------
  const urlParams = new URLSearchParams(location.search);
  const lastForm  = JSON.parse(localStorage.getItem('kakehashi:lastForm')||'{}');
  const form = {
    industry: urlParams.get('industry') || lastForm.industry || '',
    region  : urlParams.get('region')   || lastForm.region   || '',
    problem : urlParams.get('problem')  || lastForm.problem  || '',
    kpis    : (urlParams.get('kpi')||'').split(',').filter(Boolean).length
               ? (urlParams.get('kpi')||'').split(',').filter(Boolean)
               : (lastForm.kpis||[])
  };
  const forcedDemoId = urlParams.get('demo_id') || '';

  let DEMOS = [];

  // ---------- Utils ----------
  const esc = s => (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const md  = (s='') => esc(s)
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/^-\s(.+)$/gm,'<li>$1</li>')
    .replace(/(<li>[\s\S]*?<\/li>)/g,'<ul>$1</ul>')
    .replace(/\n/g,'<br>');

  const IND2CAT = (ind='') => (ind.split('/')[0] || '').trim();
  const tokenizeJa = (s='') =>
    s.toLowerCase()
     .replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0xFEE0))
     .split(/[^\p{Letter}\p{Number}]+/u).filter(Boolean);
  const jaccard = (a,b) => {
    const A=new Set(a), B=new Set(b);
    const inter=[...A].filter(x=>B.has(x)).length;
    const uni  =new Set([...A,...B]).size;
    return uni ? inter/uni : 0;
  };

  const CAT_HINT_RULES = [
    {rx:/æ—æ¥­|é½¢ç´š|ç«‹æœ¨|è·¯ç¶²|æç©/,            cat:'æ—æ¥­'},
    {rx:/æ´ªæ°´|æµ¸æ°´|å† æ°´|å°é¢¨|æ°¾æ¿«|å†…æ°´|å¤–æ°´/,    cat:'ç½å®³'},
    {rx:/åœƒå ´|ä½œä»˜|ç”Ÿè‚²|åé‡|NDVI|è¿½è‚¥|æ°´ç¨²/,    cat:'è¾²æ¥­'},
    {rx:/èµ¤æ½®|ã‚¯ãƒ­ãƒ­ãƒ•ã‚£ãƒ«|è—»é¡|HAB|é¤Šæ®–|æµ·æ³/,  cat:'æ°´ç’°å¢ƒ'},
    {rx:/ãƒ¡ã‚¿ãƒ³|ãƒ•ãƒ¬ã‚¢|æ’å‡º|ESG|CH4|ã‚¬ã‚¹|ã‚ªã‚¤ãƒ«/, cat:'ã‚¨ãƒãƒ«ã‚®ãƒ¼'}
  ];
  const inferCatsFromProblem = (text='') =>
    Array.from(new Set(CAT_HINT_RULES.filter(r => r.rx.test(text)).map(r => r.cat)));

  function scoreDemo(demo, form){
    let score = 0, reasons = [];
    const indCat = IND2CAT(form.industry);
    const probText = form.problem || '';
    const kpis = Array.isArray(form.kpis) ? form.kpis : [];

    if (indCat && demo.category === indCat){ score += 3; reasons.push('æ¥­ç•Œã‚«ãƒ†ã‚´ãƒªä¸€è‡´'); }

    const inferred = inferCatsFromProblem(probText);
    if (inferred.includes(demo.category)){ score += 2; reasons.push('è‡ªç„¶æ–‡ã‚«ãƒ†ã‚´ãƒªä¸€è‡´'); }

    const demoText = [
      demo.title, demo.summary, ...(demo.bullets||[]),
      ...((demo.steps||[]).map(s => `${s.title} ${s.body_md||''}`)),
      ...(demo.tags||[])
    ].join(' ');
    const sim = jaccard(tokenizeJa(probText), tokenizeJa(demoText));
    if (sim > 0){
      const pts = Math.min(3, Math.round(sim*4));
      score += pts;
      if (pts>0) reasons.push(`æ–‡ç« é¡ä¼¼ ${(sim*100|0)}%`);
    }

    const demoKpis = new Set(demo.kpis||[]);
    const kpiHits = kpis.filter(k => demoKpis.has(k)).length;
    if (kpiHits){ score += kpiHits*2; reasons.push(`KPIä¸€è‡´Ã—${kpiHits}`); }

    if ((demo.region_hint||[]).some(h => (form.region||'').includes(h))){ score += 1; reasons.push('åœ°åŸŸè¿‘æ¥'); }

    return {score, reasons};
  }

  function filterDemos(all, form, {minScore=1, limit=8} = {}) {
    let scored = all
      .map(d => ({ ...d, _rank: scoreDemo(d, form) }))
      .filter(x => x._rank.score >= minScore)
      .sort((a, b) => b._rank.score - a._rank.score);

    if (scored.length === 0) {
      const inferred = inferCatsFromProblem(form.problem || '');
      if (inferred.length) {
        scored = all
          .filter(d => inferred.includes(d.category))
          .map(d => ({ ...d, _rank: { score: 1, reasons: ['ç°¡æ˜“ä¸€è‡´ï¼ˆã‚«ãƒ†ã‚´ãƒªæ¨å®šï¼‰'] } }));
      }
    }
    return scored.slice(0, limit); // 0ä»¶ã¯0ä»¶ã®ã¾ã¾
  }

  function renderDoc(demo){
    if(!demo){
      demoMetaEl.textContent = 'ãƒ‡ãƒ¢æœªé¸æŠ';
      docEl.innerHTML = '<div class="note">ãƒ‡ãƒ¢ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>';
      creditEl.style.display='none'; creditEl.innerHTML='';
      demoActionsEl.innerHTML='';
      scenarioEl.textContent='ï¼ˆMVPï¼šæ–‡ç« ã§ã®ã‚·ãƒŠãƒªã‚ªè¨˜è¿°ï¼‰';
      return;
    }
    demoMetaEl.textContent =
      `${demo.title}ï½œã‚«ãƒ†ã‚´ãƒª: ${demo.category||'â€”'}ï½œãƒ‡ãƒ¼ã‚¿æº: ${(demo.data_sources||[]).join('/')}ï½œæœ€çµ‚è¦³æ¸¬: ${demo.last_obs||'â€”'}`;

    const bullets = (demo.bullets||[]).map(x=>`<li>${esc(x)}</li>`).join('');
    const steps = (demo.steps||[]).map(st=>`<div class="step"><h4>â–  ${esc(st.title)}</h4><div>${md(st.body_md||'')}</div></div>`).join('');
    const kpis = (demo.kpis||[]).map(k=>`<span class="chip" style="margin-right:6px">${esc(k)}</span>`).join('');

    docEl.innerHTML = `
      <h3 style="margin-top:0">${esc(demo.title)}</h3>
      <div style="color:#9ca3af;margin:6px 0">${esc(demo.summary||'â€”')}</div>
      ${bullets?`<ul style="margin-top:8px">${bullets}</ul>`:''}
      <div style="margin-top:10px">${steps}</div>
      ${kpis?`<div style="margin-top:12px">${kpis}</div>`:''}
    `;

    if(demo.credit?.href){
      creditEl.innerHTML = `å‡ºå…¸: <a href="${demo.credit.href}" target="_blank" rel="noopener">${esc(demo.credit.label||demo.credit.href)}</a>`;
      creditEl.style.display = 'block';
    }else{
      creditEl.style.display = 'none';
      creditEl.innerHTML = '';
    }

    demoActionsEl.innerHTML = '';
    if(demo.cta?.href){
      const a = document.createElement('a');
      a.className='btn btn-primary';
      a.href = demo.cta.href; a.target='_blank'; a.rel='noopener';
      a.textContent = demo.cta.label || 'ç›¸è«‡ã™ã‚‹';
      demoActionsEl.appendChild(a);
    }
    scenarioEl.textContent = demo.scenario || 'ï¼ˆMVPï¼šæ–‡ç« ã§ã®ã‚·ãƒŠãƒªã‚ªè¨˜è¿°ï¼‰';
  }

  function renderResults(list){
    grid.innerHTML = `
      <div class="results-header">
        <h2 style="margin:0;font-size:18px">ææ¡ˆä¸€è¦§</h2>
        <span class="results-count">è¡¨ç¤ºä»¶æ•°: ${list.length}</span>
      </div>
      <div class="cards" id="cards"></div>
    `;
    const cards = document.getElementById('cards');

    if (list.length === 0){
      leadText.textContent = 'å…¥åŠ›å†…å®¹ã«åˆè‡´ã™ã‚‹æ–‡æ›¸ãƒ‡ãƒ¢ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ¡ä»¶ã‚’åºƒã’ã¦ãŠè©¦ã—ãã ã•ã„ã€‚';
      cards.insertAdjacentHTML('beforeend',
        `<div class="result-card"><p class="result-desc" style="margin:0">è©²å½“ã™ã‚‹å€™è£œãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p></div>`);
      return;
    }

    leadText.textContent = `æ–‡æ›¸ãƒ‡ãƒ¢ ${list.length} ä»¶ã‚’è¡¨ç¤ºï¼ˆå…¥åŠ›å†…å®¹ã«åŸºã¥ãæŠ½å‡ºï¼‰`;

    list.forEach(demo=>{
      const reasons = (demo._rank?.reasons||[]).map(r=>`<span class="badge">${esc(r)}</span>`).join('');
      const kpis    = (demo.kpis||[]).map(k=>`<span class="badge kpi">ğŸ“Š ${esc(k)}</span>`).join('');
      const tags    = (demo.tags||[]).join(', ');
      const steps   = (demo.steps||[]).map(st=>`<div class="step"><h4>â–  ${esc(st.title)}</h4><div>${md(st.body_md||'')}</div></div>`).join('');

      const html = `
        <article class="result-card">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <h3 class="result-title">${esc(demo.title)}</h3>
            ${demo._rank ? `<span class="badge score-badge">åˆè‡´åº¦: ${demo._rank.score}</span>` : ''}
          </div>

          <div class="result-meta">
            <span>ã‚«ãƒ†ã‚´ãƒª: ${esc(demo.category||'â€”')}</span>
            ${tags ? `<span>ã‚¿ã‚°: ${esc(tags)}</span>` : ''}
            ${demo.region_hint?.length ? `<span>åœ°åŸŸ: ${esc(demo.region_hint.join(' / '))}</span>` : ''}
            ${demo.data_sources?.length ? `<span>ãƒ‡ãƒ¼ã‚¿æº: ${esc(demo.data_sources.join('/'))}</span>` : ''}
          </div>

          <p class="result-desc">${esc(demo.summary||'â€”')}</p>

          ${reasons ? `<div class="reason-chips">${reasons}</div>` : ''}

          ${kpis ? `<div class="kpi-wrap">${kpis}</div>` : ''}

          <div class="card-actions">
            <button class="btn btn-primary">ãƒ‡ãƒ¢ã‚’è¦‹ã‚‹</button>
            ${demo.cta?.href ? `<a class="btn btn-ghost" href="${demo.cta.href}" target="_blank" rel="noopener">${esc(demo.cta.label||'ç›¸è«‡ã™ã‚‹')}</a>`:''}
          </div>

          <details>
            <summary><span class="caret">â–¶</span> è©³ç´°ï¼ˆã‚¹ãƒ†ãƒƒãƒ—ãƒ»æ ¹æ‹ ï¼‰</summary>
            ${steps || `<div class="step" style="color:#9ca3af">è©³ç´°ã‚¹ãƒ†ãƒƒãƒ—ã¯æº–å‚™ä¸­ã§ã™ã€‚</div>`}
            ${demo.credit?.href ? `<div class="step" style="font-size:12px;color:#9ca3af">å‡ºå…¸: <a href="${demo.credit.href}" target="_blank" rel="noopener">${esc(demo.credit.label||demo.credit.href)}</a></div>`:''}
          </details>
        </article>
      `;

      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      const cardEl = wrapper.firstElementChild;

      // å³ãƒ‘ãƒãƒ«ã¨é€£å‹•
      cardEl.querySelector('.btn.btn-primary').addEventListener('click', ()=> openDemoDoc(demo.id));

      cards.appendChild(cardEl);
    });
  }

  function openDemoDoc(id){
    const d = DEMOS.find(x=>x.id===id);
    renderDoc(d);
    const q = new URLSearchParams(location.search); q.set('demo_id', id);
    history.replaceState(null, '', location.pathname+'?'+q.toString());
  }

  // ---------- èµ·å‹•ï¼šJSONèª­è¾¼ â†’ æŠ½å‡º â†’ æç”» ----------
  fetch('public/demos/demos.json', {cache:'no-store'})
    .then(r=>r.json())
    .then(json=>{
      DEMOS = json.demos||[];

      // å…¥åŠ›ãƒãƒƒãƒ—
      chipsEl.innerHTML='';
      if(form.industry){ chipsEl.insertAdjacentHTML('beforeend', `<div class="chip">æ¥­ç•Œ: ${esc(form.industry)}</div>`); }
      if(form.region){   chipsEl.insertAdjacentHTML('beforeend', `<div class="chip">åœ°åŸŸ: ${esc(form.region)}</div>`); }
      if(form.kpis?.length){ chipsEl.insertAdjacentHTML('beforeend', `<div class="chip">KPI: ${esc(form.kpis.join(' / '))}</div>`); }
      if(form.problem){  chipsEl.insertAdjacentHTML('beforeend', `<div class="chip">è‡ªç„¶æ–‡ã‚ã‚Š</div>`); }

      // å…¥åŠ›ã‚·ã‚°ãƒŠãƒ«
      const hasSignal =
        (form.industry && form.industry.trim()) ||
        (form.problem  && form.problem.trim())  ||
        (Array.isArray(form.kpis) && form.kpis.length) ||
        (form.region   && form.region.trim());

      let filtered = [];

      if (hasSignal){
        filtered = filterDemos(DEMOS, form, {minScore:1, limit:8});
        if (filtered.length === 0){
          leadText.textContent = 'å…¥åŠ›å†…å®¹ã«åˆè‡´ã™ã‚‹æ–‡æ›¸ãƒ‡ãƒ¢ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ¡ä»¶ã‚’åºƒã’ã¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        } else {
          leadText.textContent = `æ–‡æ›¸ãƒ‡ãƒ¢ ${filtered.length} ä»¶ã‚’è¡¨ç¤ºï¼ˆå…¥åŠ›å†…å®¹ã«åŸºã¥ãæŠ½å‡ºï¼‰`;
        }
      } else {
        const defId = json.default_demo_id || (DEMOS[0]?.id);
        filtered = DEMOS.filter(d => d.id === defId);
        leadText.textContent = 'ï¼ˆå…¥åŠ›ãŒæœªæŒ‡å®šã®ãŸã‚ï¼‰ä»£è¡¨çš„ãªæ–‡æ›¸ãƒ‡ãƒ¢ã®ã¿è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚';
      }

      renderResults(filtered);

      // åˆæœŸé¸æŠ
      const initial = forcedDemoId || (filtered[0]?.id) || json.default_demo_id || (DEMOS[0]?.id);
      if(initial) openDemoDoc(initial);
    })
    .catch(()=>{
      docEl.innerHTML='<div class="note">demos.json ã®èª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>';
    });
});
</script>
</body>
</html>
