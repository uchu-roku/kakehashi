<script>
  // ＝＝＝ 追加：最小入力ガイド（業界 or 自然文のどちらか1つでOK） ＝＝＝
  (function injectMinGuide(){
    const card = document.querySelector('.card');
    if(!card) return;
    const note = document.createElement('div');
    note.style.margin = '6px 0 14px';
    note.innerHTML = `
      <div class="badge" style="display:inline-flex;align-items:center;gap:6px;border:1px solid #2a3953;background:#0b1326;border-radius:999px;padding:6px 10px;font-size:12px;color:#cbd5e1">
        最小入力：<strong>業界</strong> <span style="opacity:.6">or</span> <strong>課題（自然文）</strong> のどちらか1つでOK
      </div>
    `;
    const h1 = card.querySelector('h1');
    h1.insertAdjacentElement('afterend', note);
  })();

  // === 既存のNLC/SEGルール（必要最小だけ抽出・流用） ===
  const NLC_RULES = {
    "インフラ点検/建設": ["橋梁","舗装","法面","変位","沈下","施工","出来形","BIM","CIM","インフラ","InSAR","地盤"],
    "エネルギー/排出監視": ["メタン","フレア","排出","GHG","ESG","二酸化炭素","CO2","オイル","ガス","リーク"],
    "林業": ["間伐","皆伐","材積","保育","林班","路網","森林在庫","立木","造林","山火事","火災"],
    "水環境/養殖": ["養殖","生簀","赤潮","HAB","水温","漁場","海況","クロロフィル","SST"],
    "災害/保険": ["浸水","洪水","被害","台風","保険金","査定","冠水","土砂","災害"],
    "農業": ["圃場","作付け","生育","収量","追肥","NDVI","水稲","畑作","耕作放棄地"]
  };
  function classifyIndustry(text){
    const t = (text||"").toLowerCase();
    let best = {label:"",score:0};
    for(const [label,words] of Object.entries(NLC_RULES)){
      const s = words.reduce((acc,w)=> acc + (t.includes(w.toLowerCase())?1:0), 0);
      if(s>best.score) best={label,score:s};
    }
    const conf = Math.min(1, best.score/3);
    return best.score>0 ? {label:best.label, confidence:conf} : null;
  }
  const KEYWORD_TO_SEG = [
    {rx:/洪水|浸水|冠水|氾濫|内水|外水/, seg:"SEG_FLOOD", label:"洪水・浸水"},
    {rx:/赤潮|クロロフィル|藻類|HAB/, seg:"SEG_REDTIDE", label:"赤潮"},
    {rx:/メタン|フレア|排出|CH4|リーク/, seg:"SEG_METHANE", label:"メタン監視"},
    {rx:/森林|材積|路網|間伐|皆伐|在庫/, seg:"SEG_FORESTRY_SME", label:"森林在庫"},
    {rx:/圃場|生育|NDVI|作付|収量/, seg:"SEG_AGRI_PROD", label:"農業NDVI"}
  ];
  function segsFromText(text){
    const hits = new Set(); const t = text || "";
    KEYWORD_TO_SEG.forEach(({rx,seg})=>{ if(rx.test(t)) hits.add(seg); });
    return Array.from(hits);
  }
  const SEG_RULES = {
    "インフラ点検/建設": { base: ["SEG_CONSTRUCT","SEG_INFRA_O&M"] },
    "エネルギー/排出監視": { base: ["SEG_OILGAS","SEG_REGULATOR"] },
    "林業": { base: ["SEG_FORESTRY_SME","SEG_TIMBER_TRADER","SEG_FORESTRY_PUBLIC"] },
    "水環境/養殖": { base: ["SEG_AQUA_SME","SEG_AQUA_CORP"] },
    "災害/保険": { base: ["SEG_INSURANCE","SEG_EMERGENCY","SEG_FLOOD"] },
    "農業": { base: ["SEG_AGRI_PROD","SEG_AGRI_LOCALGOV","SEG_LOCALGOV","SEG_JA"] }
  };
  function deriveSegs(industry, kpis){
    const base = (SEG_RULES[industry]?.base)||[];
    const bonus = [];
    if(kpis.includes("CO2/ESG")) bonus.push("SEG_REGULATOR");
    if(kpis.includes("安全/リスク低減")) bonus.push("SEG_EMERGENCY","SEG_INSURANCE");
    return Array.from(new Set([...base, ...bonus]));
  }

  // === 既存UI参照 ===
  const problem = document.getElementById('problem');
  const industry = document.getElementById('industry');
  const region = document.getElementById('region');
  const nlcHint = document.getElementById('nlcHint');
  const segHint = document.getElementById('segHint');
  const charCounter = document.getElementById('charCounter');
  const insertExample = document.getElementById('insertExample');

  // ＝＝＝ 新：推定チップUI（クリックで採用/解除できる） ＝＝＝
  const hintBar = document.createElement('div');
  hintBar.className = 'chips';
  hintBar.style.margin = '8px 0';
  problem.parentElement.insertAdjacentElement('afterend', hintBar);

  function renderHints(text){
    hintBar.innerHTML = '';
    // 業界推定
    const r = classifyIndustry(text);
    if(r){
      nlcHint.textContent = `推定：${r.label}（信頼度 ${r.confidence.toFixed(2)}）`;
      const c = document.createElement('div'); c.className='chip';
      c.innerHTML = `<label>推定業界：${r.label}</label>`;
      c.style.cursor='pointer';
      c.onclick = ()=>{ industry.value = (industry.value===r.label ? "" : r.label); };
      hintBar.appendChild(c);
    }else{
      nlcHint.textContent = "";
    }
    // SEG推定
    const segs = segsFromText(text);
    if(segs.length){
      const c = document.createElement('div'); c.className='chip';
      c.innerHTML = `<label>検出SEG：${segs.join(", ")}</label>`;
      hintBar.appendChild(c);
    }
  }

  // 入力イベント
  problem.addEventListener('input', ()=>{
    renderHints(problem.value);
    charCounter.textContent = `${problem.value.length} / ${problem.maxLength}`;
  });
  insertExample.addEventListener('click', ()=>{
    problem.value = "豪雨のとき、どの道路が浸水しやすいか事前に把握したい。";
    problem.dispatchEvent(new Event('input'));
  });

  // ＝＝＝ 新：最小入力バリデーション（業界 or 自然文 のいずれか1つでOK） ＝＝＝
  document.getElementById('diagForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const kpis = Array.from(document.querySelectorAll('input[name="kpi"]:checked')).map(i=>i.value);
    const hasIndustry = !!industry.value;
    const hasProblem  = !!problem.value.trim();

    // これまでの「業界必須」を廃止 → 最小入力ルールに変更
    if(!hasIndustry && !hasProblem){
      // 軽量エラー表示
      problem.classList.add('is-invalid');
      industry.classList.add('is-invalid');
      alert("最小入力：業界 か 課題（自然文）のどちらか1つを入力してください。");
      return;
    }else{
      problem.classList.remove('is-invalid');
      industry.classList.remove('is-invalid');
    }

    // SEG導出（テキスト由来＋業界/KPI由来）
    const segBase = deriveSegs(industry.value, kpis);
    const segFromText = segsFromText(problem.value);
    const segsAll = Array.from(new Set([...segBase, ...segFromText]));

    // 保存＆遷移
    const formPayload = { industry: industry.value, region: region.value.trim(), problem: problem.value.trim(), kpis, segs: segsAll };
    localStorage.setItem('kakehashi:lastForm', JSON.stringify(formPayload));
    localStorage.setItem('kakehashi:lastSegs', JSON.stringify(formPayload.segs||[]));
    const params = new URLSearchParams({ industry:formPayload.industry, region:formPayload.region, problem:formPayload.problem, kpi:kpis.join(',') });
    location.href = 'results.html?' + params.toString();
  });

  // 復元
  (()=>{
    const last = localStorage.getItem('kakehashi:lastForm');
    if(!last) return;
    try{
      const v = JSON.parse(last);
      if(v.industry) industry.value = v.industry;
      if(v.region)   region.value   = v.region;
      if(v.problem){ problem.value = v.problem; problem.dispatchEvent(new Event('input')); }
      if(Array.isArray(v.kpis)) v.kpis.forEach(k=>{
        const el = Array.from(document.querySelectorAll('input[name="kpi"]')).find(n=>n.value===k);
        if(el) el.checked = true;
      });
    }catch(e){}
  })();
</script>
