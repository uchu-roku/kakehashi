<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KAKEHASHI | 衛星データ活用診断（入口）</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #131a33;
      --text: #e7ecff;
      --muted: #9fb1ffcc;
      --accent: #5b8cff;
      --accent2: #6ee7b7;
      --border: #243058;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      background: radial-gradient(1000px 600px at 10% -10%, #18224b 0%, var(--bg) 60%);
      color: var(--text);
      line-height: 1.6;
    }
    header {
      padding: 28px 20px 10px;
    }
    .container { max-width: 980px; margin: 0 auto; padding: 0 20px 60px; }
    .title { font-size: 28px; font-weight: 800; letter-spacing: .5px; }
    .subtitle { color: var(--muted); margin-top: 6px; }
    .card {
      background: linear-gradient(180deg, #151c3a, #101735);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 22px;
      margin-top: 18px;
      box-shadow: 0 8px 24px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
    }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
    label { font-weight: 700; font-size: 14px; color: var(--muted); display:block; margin-bottom:8px; }
    select, textarea, input[type="text"] {
      width: 100%; background: #0f1530; color: var(--text);
      border: 1px solid var(--border); border-radius: 12px; padding: 12px 14px;
      outline: none; font-size: 15px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.03);
    }
    textarea { min-height: 110px; resize: vertical; }
    .hint { font-size: 12px; color: var(--muted); margin-top: 6px; }
    .btnbar { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .btn {
      appearance: none; border: 0; border-radius: 14px;
      padding: 12px 18px; font-weight: 800; letter-spacing: .2px;
      cursor: pointer; transition: transform .06s ease;
      background: linear-gradient(180deg, var(--accent), #3b5ef0);
      color: white; box-shadow: 0 8px 20px rgba(59,94,240,.35);
    }
    .btn.secondary {
      background: linear-gradient(180deg, #1e293b, #0f172a);
      color: var(--text); border: 1px solid var(--border);
      box-shadow: none;
    }
    .btn:active { transform: translateY(1px); }
    .pill {
      display:inline-flex; align-items:center; gap:8px; padding: 4px 10px;
      border:1px dashed var(--border); border-radius: 999px; color: var(--muted);
      font-size: 12px;
    }
    .footer { margin-top: 16px; color: var(--muted); font-size: 12px; }
    .badges { display:flex; gap:8px; flex-wrap: wrap; }
    .tag { padding: 6px 10px; border-radius: 999px; background:#0f1733; border:1px solid var(--border); font-size:12px; color:#b7c7ff; }

    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;background:#0f1733;
      border:1px solid var(--border);color:#b7c7ff;cursor:pointer;user-select:none;font-size:13px;
    }
    .chip.active{border-color:#5b8cff;box-shadow:0 0 0 1px #5b8cff33 inset}
  </style>
</head>
<body>
  <header class="container">
    <div class="title">KAKEHASHI｜衛星データ活用診断</div>
    <div class="subtitle">業界とビジネス課題から、あなたに合うデモ事例をおすすめします。</div>
  </header>

  <main class="container">
    <section class="card">
      <div class="badges">
        <span class="pill">v2 (cases-db.json対応)</span>
        <span class="tag">Industry × Business Need</span>
        <span class="tag">自然文入力OK</span>
        <span class="tag">KPI任意</span>
      </div>

      <div class="grid" style="margin-top: 16px;">
        <div>
          <label for="industry">業界（Industry）</label>
          <select id="industry">
            <option value="">— 選択してください —</option>
          </select>
          <div class="hint">cases-db.json から自動抽出</div>
        </div>
        <div>
          <label>一般的なビジネス課題（複数選択）</label>
          <div id="needChips" class="chips" role="group" aria-label="Business Needs"></div>
          <div class="hint">クリックで選択／解除。複数選択できます。</div>
        </div>
      </div>

      <div class="grid" style="margin-top: 16px;">
        <div>
          <label for="keywords">自由記述（任意）</label>
          <input id="keywords" type="text" placeholder="例：法面変位を早期検知したい、漁場探索の燃料を減らしたい…">
          <div class="hint">あなたの言葉で課題を書いてください。結果の並び順に反映されます。</div>
        </div>
        <div>
          <label>重視するKPI（複数選択・任意）</label>
          <div id="kpiChips" class="chips" role="group" aria-label="KPIs"></div>
          <div class="hint">KPIは並び替えやハイライトの参考にします。</div>
        </div>
      </div>

      <div class="footer">
        入力は匿名で処理されます。送信すると <code>results.html</code> に遷移します。
      </div>
      <div class="btnbar" style="margin-top: 16px;">
        <button class="btn" id="submitBtn">デモを探す</button>
        <button class="btn secondary" id="resetBtn">リセット</button>
      </div>
    </section>

    <section class="card">
      <div style="font-weight:800; margin-bottom:8px;">プレビュー（該当件数と例）</div>
      <div id="preview" class="hint">cases-db.json を読み込み中…</div>
    </section>
  </main>

  <script>
    const state = { cases: [], industries: new Set(), needs: new Set() };
  
    const NEEDS_FALLBACK = [
      'コスト削減','品質向上','安全・リスク低減','監視の自動化','進捗可視化','ESG/CO2','需要予測','被害推定','在庫把握'
    ];
    const KPI_FALLBACK = ['コスト削減','品質向上','工数・省力化','安全・リスク','進捗可視化','ESG/CO2'];
  
    const elIndustry = document.getElementById('industry');
    const elNeedChips = document.getElementById('needChips');
    const elKpiChips = document.getElementById('kpiChips');
  
    function makeChip(text, container){
      const span = document.createElement('span');
      span.className = 'chip';
      span.textContent = text;
      span.addEventListener('click', () => { span.classList.toggle('active'); renderPreview(); });
      container.appendChild(span);
    }
    function selectedTexts(container){
      return Array.from(container.querySelectorAll('.chip.active')).map(s => s.textContent);
    }
  
    async function loadCases() {
      try {
        const res = await fetch('cases-db.json', { cache: 'no-store' });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        state.cases = Array.isArray(data) ? data : (data.cases || []);
  
        state.industries = new Set(state.cases.map(i => i.industry).filter(Boolean));
        state.needs      = new Set(state.cases.map(i => i.business_need).filter(Boolean));
  
        // 業界
        [...state.industries].sort().forEach(v => {
          const opt = document.createElement('option'); opt.value = v; opt.textContent = v; elIndustry.appendChild(opt);
        });
        // 課題チップ
        elNeedChips.innerHTML=''; [...state.needs].sort().forEach(v => makeChip(v, elNeedChips));
        // KPIチップ
        elKpiChips.innerHTML=''; KPI_FALLBACK.forEach(v => makeChip(v, elKpiChips));
  
        renderPreview();
      } catch (e) {
        // フォールバック（JSONが404でも動作）
        document.getElementById('preview').textContent = 'cases-db.json の読み込みに失敗しました（' + e.message + '）。固定候補で動作します。';
        ['農業','林業','災害/保険','水環境/養殖','エネルギー/排出監視','インフラ点検/建設'].forEach(v => {
          const opt = document.createElement('option'); opt.value = v; opt.textContent = v; elIndustry.appendChild(opt);
        });
        elNeedChips.innerHTML=''; NEEDS_FALLBACK.forEach(v => makeChip(v, elNeedChips));
        elKpiChips.innerHTML=''; KPI_FALLBACK.forEach(v => makeChip(v, elKpiChips));
      }
    }
  
    function filterCases() {
      const industry = elIndustry.value.trim();
      const needs = selectedTexts(elNeedChips); // 複数
      const q = document.getElementById('keywords').value.trim().toLowerCase();
  
      return state.cases.filter(c => {
        const okIndustry = !industry || c.industry === industry;
        const okNeeds = !needs.length || needs.includes(c.business_need);
        const okKw = !q || (
          (c.problem && c.problem.toLowerCase().includes(q)) ||
          (c.solution && c.solution.toLowerCase().includes(q)) ||
          (c.kpi && c.kpi.toLowerCase().includes(q))
        );
        return okIndustry && okNeeds && okKw;
      });
    }
  
    function renderPreview() {
      if(!state.cases.length){ return; } // フォールバック時は件数プレビュー無し
      const list = filterCases();
      const box = document.getElementById('preview');
      if (!list.length) { box.innerHTML = '該当する事例がまだありません。条件を調整してください。'; return; }
      const top = list.slice(0, 3);
      const html = [`<div>該当 <b>${list.length}</b> 件</div>`]
        .concat(top.map(c => `
        <div style="margin-top:10px;padding:10px;border:1px solid var(--border);border-radius:10px;background:#0e1533;">
          <div style="font-weight:700">${c.industry} × ${c.business_need}</div>
          <div style="margin-top:6px"><b>課題:</b> ${c.problem}</div>
          <div><b>解決:</b> ${c.solution}</div>
          <div style="color:var(--muted);font-size:12px;margin-top:4px;">KPI: ${c.kpi}</div>
        </div>`)).join('');
      box.innerHTML = html;
    }
  
    document.getElementById('resetBtn').addEventListener('click', () => {
      elIndustry.value = '';
      document.querySelectorAll('.chip.active').forEach(el => el.classList.remove('active'));
      document.getElementById('keywords').value = '';
      renderPreview();
    });
  
    document.getElementById('submitBtn').addEventListener('click', () => {
      const industry = encodeURIComponent(elIndustry.value.trim());
      const needs = encodeURIComponent(selectedTexts(elNeedChips).join(','));  // 複数をカンマ連結
      const q = encodeURIComponent(document.getElementById('keywords').value.trim());
      const kpis = encodeURIComponent(selectedTexts(elKpiChips).join(','));
      const url = `results.html?industry=${industry}&need=${needs}&q=${q}&kpi=${kpis}`;
      window.location.href = url;
    });
  
    elIndustry.addEventListener('change', renderPreview);
    document.getElementById('keywords').addEventListener('input', renderPreview);
  
    loadCases();
  </script>

</body>
</html>
