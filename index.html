<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KAKEHASHI ãƒ‡ãƒ¢ | è¡›æ˜Ÿãƒ‡ãƒ¼ã‚¿æ´»ç”¨è¨ºæ–­ï¼ˆå…¥åŠ› v1.3ï¼‰</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap&display=swap" rel="stylesheet">
<style>
  :root { --bg:#0b1020; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; --accent2:#a78bfa; --danger:#dc2626; --chip:#0b1326; --chipb:#2a3953; }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 600px at 80% -10%, rgba(167,139,250,.25), transparent),var(--bg);color:var(--text);font-family:Inter,system-ui,"Noto Sans JP",sans-serif}
  header{padding:24px;border-bottom:1px solid #1f2937;position:sticky;top:0;background:linear-gradient(180deg,rgba(17,24,39,.9),rgba(17,24,39,.7));backdrop-filter:blur(6px);z-index:10}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  .card{background:linear-gradient(180deg,rgba(31,41,55,.75),rgba(17,24,39,.9));border:1px solid #243045;border-radius:16px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  h1{margin:0 0 8px;font-size:28px}
  p.lead{margin:0 0 18px;color:var(--muted);line-height:1.7}
  label{display:block;margin:16px 0 8px;font-weight:600;color:#cbd5e1}
  select,textarea,input[type="text"]{width:100%;background:#0f172a;color:var(--text);border:1px solid #243045;border-radius:12px;padding:12px 14px;outline:none}
  textarea{min-height:120px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip input{display:none}
  .chip label{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--chipb);background:var(--chip);cursor:pointer;color:#cbd5e1;font-size:14px}
  .chip input:checked+label{border-color:#3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,.3) inset;color:#e5e7eb}
  .actions{display:flex;gap:12px;margin-top:20px}
  .btn{appearance:none;border:none;padding:12px 18px;border-radius:12px;font-weight:700;cursor:pointer;transition:.2s}
  .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0b1020}
  .btn-primary:hover{filter:brightness(1.1);transform:translateY(-1px)}
  .btn-ghost{background:transparent;color:#cbd5e1;border:1px solid #2a3953}
  .note{font-size:12px;color:#9ca3af;margin-top:6px}
  .hint{margin:8px 0;color:#9ca3af;font-size:12px}
  .counter{font-size:12px;color:#9ca3af;text-align:right;margin-top:4px}
  :focus-visible{outline:2px solid var(--accent);outline-offset:2px}
  .is-invalid{border-color:var(--danger);box-shadow:0 0 0 2px rgba(220,38,38,.2) inset}
  .stepper{display:flex;gap:8px;font-size:12px;color:#9ca3af;align-items:center}
  .stepper .dot{width:8px;height:8px;border-radius:999px;background:#334155}
  .stepper .dot.active{background:var(--accent)}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #2a3953;background:#0b1326;border-radius:999px;padding:4px 10px;font-size:12px;color:#cbd5e1}
  /* ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ */
  .wizard{margin-top:16px;border:1px dashed #2a3953;border-radius:12px;padding:14px;background:#0b1326}
  .wizard h3{margin:0 0 8px;font-size:16px}
  .wiz-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
  .wiz-col{display:flex;flex-wrap:wrap;gap:6px}
  .wiz-tag{font-size:12px;border:1px solid #243045;background:#0f172a;border-radius:999px;padding:6px 10px;cursor:pointer}
  .wiz-tag.active{border-color:#3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,.3) inset}
  .sugg{border:1px solid #2a3953;background:#0b1326;border-radius:10px;padding:10px;margin-top:10px}
  .sugg h4{margin:0 0 4px;font-size:14px}
  .sugg p{margin:0;color:#9ca3af;font-size:12px}
</style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;">
      <div class="brand" style="font-weight:800;letter-spacing:.3px;">KAKEHASHI ãƒ‡ãƒ¢</div>
      <div class="stepper" aria-label="é€²è¡ŒçŠ¶æ³">
        <span class="dot active"></span><span>â‘  èª²é¡Œå…¥åŠ›</span><span style="opacity:.5;">â†’</span>
        <span class="dot"></span><span style="opacity:.7;">â‘¡ ææ¡ˆç¢ºèª</span><span style="opacity:.5;">â†’</span>
        <span class="dot"></span><span style="opacity:.7;">â‘¢ ãƒ‡ãƒ¢ã‚’è¦‹ã‚‹</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <h1>è¡›æ˜Ÿãƒ‡ãƒ¼ã‚¿æ´»ç”¨è¨ºæ–­</h1>
      <p class="lead">å°‚é–€ç”¨èªã¯ä¸è¦ã§ã™ã€‚ã„ã¤ã‚‚ã®æ¥­å‹™ã®ã“ã¨ã°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>

      <form id="diagForm" novalidate>
        <div class="row">
          <div>
            <label for="industry">æ¥­ç•Œã‚«ãƒ†ã‚´ãƒª</label>
            <select id="industry" required aria-describedby="industryHelp">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="ã‚¤ãƒ³ãƒ•ãƒ©ç‚¹æ¤œ/å»ºè¨­">ã‚¤ãƒ³ãƒ•ãƒ©ç‚¹æ¤œ/å»ºè¨­</option>
              <option value="ã‚¨ãƒãƒ«ã‚®ãƒ¼/æ’å‡ºç›£è¦–">ã‚¨ãƒãƒ«ã‚®ãƒ¼/æ’å‡ºç›£è¦–</option>
              <option value="æ—æ¥­">æ—æ¥­</option>
              <option value="æ°´ç’°å¢ƒ/é¤Šæ®–">æ°´ç’°å¢ƒ/é¤Šæ®–</option>
              <option value="ç½å®³/ä¿é™º">ç½å®³/ä¿é™º</option>
              <option value="è¾²æ¥­">è¾²æ¥­</option>
            </select>
            <div class="note" id="industryHelp">è‡ªç„¶æ–‡ãƒ»ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã‹ã‚‰è‡ªå‹•æ¨å®šã—ã¾ã™ã€‚èª¤ã£ã¦ã„ãŸã‚‰ä¸Šæ›¸ãã—ã¦ãã ã•ã„ã€‚</div>
            <div id="nlcHint" class="hint" aria-live="polite"></div>
            <div id="segHint" class="hint"></div>
          </div>
          <div>
            <label for="region">å¯¾è±¡åœ°åŸŸï¼ˆä»»æ„ï¼‰</label>
            <input id="region" type="text" placeholder="ä¾‹ï¼šæœ­å¹Œå¸‚ï¼åŒ—æµ·é“ï¼ç¦å²¡å¸‚ãªã©ï¼ˆä»»æ„ï¼‰">
            <div class="note">åœ°åŸŸã¯åœ°å›³ã®ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°ãƒ»åœ°åŸŸå„ªå…ˆè¡¨ç¤ºã«ä½¿ã„ã¾ã™</div>
          </div>
        </div>

        <label for="problem">ç¾å ´ã®èª²é¡Œï¼ˆè‡ªç„¶æ–‡ï¼‰</label>
        <textarea id="problem" placeholder="ä¾‹ï¼‰è±ªé›¨ã®ã¨ãã€ã©ã®é“è·¯ãŒæµ¸æ°´ã—ã‚„ã™ã„ã‹äº‹å‰ã«æŠŠæ¡ã—ãŸã„ã€‚" maxlength="400" aria-describedby="problemHelp"></textarea>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px;">
          <button type="button" class="btn btn-ghost" id="insertExample">ä¾‹æ–‡ã‚’æŒ¿å…¥</button>
          <div class="counter" id="charCounter" aria-live="polite" style="margin-left:auto;">0 / 400</div>
        </div>
        <div class="note" id="problemHelp">ä¾‹ï¼šæ´ªæ°´ãƒ»èµ¤æ½®ãƒ»ãƒ¡ã‚¿ãƒ³ãƒ»æ£®æ—ãƒ»åœƒå ´ ãªã©ã®è¨€è‘‰ãŒå…¥ã‚‹ã¨ç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™ã€‚</div>

        <!-- ğŸ§­ ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ï¼ˆæ¥­ç•Œâ†’å›°ã‚Šã”ã¨â†’æœŸå¾…æˆæœï¼‰ -->
        <div class="wizard" id="wizard">
          <h3>ã‹ã‚“ãŸã‚“ã‚¬ã‚¤ãƒ‰ï¼ˆè³ªå•ã«ç­”ãˆã‚‹ã ã‘ï¼‰</h3>
          <div class="wiz-row">
            <div>
              <div style="font-size:12px;color:#9ca3af;margin-bottom:6px;">1. ã‚ãªãŸã®æ¥­ç•Œ</div>
              <div class="wiz-col" id="wizInd"></div>
            </div>
            <div>
              <div style="font-size:12px;color:#9ca3af;margin-bottom:6px;">2. å›°ã‚Šã”ã¨</div>
              <div class="wiz-col" id="wizProb"></div>
            </div>
            <div>
              <div style="font-size:12px;color:#9ca3af;margin-bottom:6px;">3. æœŸå¾…ã™ã‚‹æˆæœ</div>
              <div class="wiz-col" id="wizKpi"></div>
            </div>
          </div>
          <div class="sugg" id="wizSugg" style="display:none"></div>
        </div>

        <label>é‡è¦–ã™ã‚‹ç›®çš„/KPIï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
        <div class="chips" role="group" aria-label="é‡è¦–KPI">
          <div class="chip"><input id="kpi_0" type="checkbox" name="kpi" value="ã‚³ã‚¹ãƒˆå‰Šæ¸›"><label for="kpi_0">ã‚³ã‚¹ãƒˆå‰Šæ¸›</label></div>
          <div class="chip"><input id="kpi_1" type="checkbox" name="kpi" value="é€²æ—å¯è¦–åŒ–"><label for="kpi_1">é€²æ—å¯è¦–åŒ–</label></div>
          <div class="chip"><input id="kpi_2" type="checkbox" name="kpi" value="å“è³ªå‘ä¸Š"><label for="kpi_2">å“è³ªå‘ä¸Š</label></div>
          <div class="chip"><input id="kpi_3" type="checkbox" name="kpi" value="å®‰å…¨/ãƒªã‚¹ã‚¯ä½æ¸›"><label for="kpi_3">å®‰å…¨/ãƒªã‚¹ã‚¯ä½æ¸›</label></div>
          <div class="chip"><input id="kpi_4" type="checkbox" name="kpi" value="CO2/ESG"><label for="kpi_4">CO2/ESG</label></div>
          <div class="chip"><input id="kpi_5" type="checkbox" name="kpi" value="åŠ´å‹™çœåŠ›åŒ–"><label for="kpi_5">åŠ´å‹™çœåŠ›åŒ–</label></div>
        </div>

        <div class="actions">
          <button class="btn btn-primary" type="submit">è¨ºæ–­ã™ã‚‹ â†’</button>
          <button class="btn btn-ghost" type="reset">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </form>
    </div>
  </main>

  <footer style="color:#6b7280;text-align:center;font-size:12px;padding:24px;">Â© 2025 KAKEHASHI Project â€“ Prototype (v1.3)</footer>

  <script>
    // === v1.1ã®åˆ†é¡ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶™æ‰¿ï¼ˆè‡ªç„¶æ–‡â†’æ¥­ç•Œ/NLCãƒ»SEGï¼‰ ===
    const NLC_RULES = {
      "ã‚¤ãƒ³ãƒ•ãƒ©ç‚¹æ¤œ/å»ºè¨­": ["æ©‹æ¢","èˆ—è£…","æ³•é¢","å¤‰ä½","æ²ˆä¸‹","æ–½å·¥","å‡ºæ¥å½¢","BIM","CIM","ã‚¤ãƒ³ãƒ•ãƒ©","InSAR","åœ°ç›¤"],
      "ã‚¨ãƒãƒ«ã‚®ãƒ¼/æ’å‡ºç›£è¦–": ["ãƒ¡ã‚¿ãƒ³","ãƒ•ãƒ¬ã‚¢","æ’å‡º","GHG","ESG","äºŒé…¸åŒ–ç‚­ç´ ","CO2","ã‚ªã‚¤ãƒ«","ã‚¬ã‚¹","ãƒªãƒ¼ã‚¯"],
      "æ—æ¥­": ["é–“ä¼","çš†ä¼","æç©","ä¿è‚²","æ—ç­","è·¯ç¶²","æ£®æ—åœ¨åº«","ç«‹æœ¨","é€ æ—","å±±ç«äº‹","ç«ç½"],
      "æ°´ç’°å¢ƒ/é¤Šæ®–": ["é¤Šæ®–","ç”Ÿç°€","èµ¤æ½®","HAB","æ°´æ¸©","æ¼å ´","æµ·æ³","ã‚¯ãƒ­ãƒ­ãƒ•ã‚£ãƒ«","SST"],
      "ç½å®³/ä¿é™º": ["æµ¸æ°´","æ´ªæ°´","è¢«å®³","å°é¢¨","ä¿é™ºé‡‘","æŸ»å®š","å† æ°´","åœŸç ‚","ç½å®³"],
      "è¾²æ¥­": ["åœƒå ´","ä½œä»˜ã‘","ç”Ÿè‚²","åé‡","è¿½è‚¥","NDVI","æ°´ç¨²","ç•‘ä½œ","è€•ä½œæ”¾æ£„åœ°"]
    };
    function classifyIndustry(text){
      const t = (text||"").toLowerCase();
      let best = {label:"",score:0};
      for(const [label,words] of Object.entries(NLC_RULES)){
        const s = words.reduce((acc,w)=> acc + (t.includes(w.toLowerCase())?1:0), 0);
        if(s>best.score) best={label,score:s};
      }
      const conf = Math.min(1, best.score/3);
      return best.score>0 ? {label:best.label, confidence:conf} : null;
    }
    const KEYWORD_TO_SEG = [
      {rx:/æ´ªæ°´|æµ¸æ°´|å† æ°´|æ°¾æ¿«|å†…æ°´|å¤–æ°´/, seg:"SEG_FLOOD", label:"æ´ªæ°´ãƒ»æµ¸æ°´"},
      {rx:/èµ¤æ½®|ã‚¯ãƒ­ãƒ­ãƒ•ã‚£ãƒ«|è—»é¡|HAB/, seg:"SEG_REDTIDE", label:"èµ¤æ½®"},
      {rx:/ãƒ¡ã‚¿ãƒ³|ãƒ•ãƒ¬ã‚¢|æ’å‡º|CH4|ãƒªãƒ¼ã‚¯/, seg:"SEG_METHANE", label:"ãƒ¡ã‚¿ãƒ³ç›£è¦–"},
      {rx:/æ£®æ—|æç©|è·¯ç¶²|é–“ä¼|çš†ä¼|åœ¨åº«/, seg:"SEG_FORESTRY_SME", label:"æ£®æ—åœ¨åº«"},
      {rx:/åœƒå ´|ç”Ÿè‚²|NDVI|ä½œä»˜|åé‡/, seg:"SEG_AGRI_PROD", label:"è¾²æ¥­NDVI"}
    ];
    function segsFromText(text){
      const hits = new Set(); const t = text || "";
      KEYWORD_TO_SEG.forEach(({rx,seg})=>{ if(rx.test(t)) hits.add(seg); });
      return Array.from(hits);
    }
    const SEG_RULES = {
      "ã‚¤ãƒ³ãƒ•ãƒ©ç‚¹æ¤œ/å»ºè¨­": { base: ["SEG_CONSTRUCT","SEG_INFRA_O&M"] },
      "ã‚¨ãƒãƒ«ã‚®ãƒ¼/æ’å‡ºç›£è¦–": { base: ["SEG_OILGAS","SEG_REGULATOR"] },
      "æ—æ¥­": { base: ["SEG_FORESTRY_SME","SEG_TIMBER_TRADER","SEG_FORESTRY_PUBLIC"] },
      "æ°´ç’°å¢ƒ/é¤Šæ®–": { base: ["SEG_AQUA_SME","SEG_AQUA_CORP"] },
      "ç½å®³/ä¿é™º": { base: ["SEG_INSURANCE","SEG_EMERGENCY","SEG_FLOOD"] },
      "è¾²æ¥­": { base: ["SEG_AGRI_PROD","SEG_AGRI_LOCALGOV","SEG_LOCALGOV","SEG_JA"] }
    };
    function deriveSegs(industry, kpis){
      const base = (SEG_RULES[industry]?.base)||[];
      const bonus = [];
      if(kpis.includes("CO2/ESG")) bonus.push("SEG_REGULATOR");
      if(kpis.includes("å®‰å…¨/ãƒªã‚¹ã‚¯ä½æ¸›")) bonus.push("SEG_EMERGENCY","SEG_INSURANCE");
      return Array.from(new Set([...base, ...bonus]));
    }

    // === ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ï¼ˆé¡§å®¢è¨€èªã§ã®é¸æŠè‚¢ï¼‰ ===
    const WIZ = {
      industry: ["è¾²æ¥­","æ—æ¥­","ç½å®³/ä¿é™º","æ°´ç’°å¢ƒ/é¤Šæ®–","ã‚¤ãƒ³ãƒ•ãƒ©ç‚¹æ¤œ/å»ºè¨­","ã‚¨ãƒãƒ«ã‚®ãƒ¼/æ’å‡ºç›£è¦–"],
      problem: ["è¢«å®³ã‚’æ¸›ã‚‰ã—ãŸã„","å“è³ªã®ãƒ ãƒ©ã‚’æ¸›ã‚‰ã—ãŸã„","ä½œæ¥­ã‚’çœåŠ›åŒ–ã—ãŸã„","ç‚¹æ¤œã®æŠœã‘æ¼ã‚Œã‚’é˜²ããŸã„","ç’°å¢ƒè² è·/CO2ã‚’æ¸›ã‚‰ã—ãŸã„"],
      kpi: ["ã‚³ã‚¹ãƒˆå‰Šæ¸›","é€²æ—å¯è¦–åŒ–","å“è³ªå‘ä¸Š","å®‰å…¨/ãƒªã‚¹ã‚¯ä½æ¸›","CO2/ESG","åŠ´å‹™çœåŠ›åŒ–"]
    };
    const wizInd = document.getElementById('wizInd');
    const wizProb = document.getElementById('wizProb');
    const wizKpi  = document.getElementById('wizKpi');
    const wizSugg = document.getElementById('wizSugg');
    const selected = {industry:null, problem:null, kpi: new Set()};

    function tag(container, text, on){
      const el = document.createElement('div'); el.className='wiz-tag'; el.textContent=text;
      el.addEventListener('click', ()=> on(el));
      container.appendChild(el); return el;
    }
    WIZ.industry.forEach(v => tag(wizInd, v, (el)=>{ [...wizInd.children].forEach(c=>c.classList.remove('active')); el.classList.add('active'); selected.industry=v; document.getElementById('industry').value=v; refreshWizard(); }));
    WIZ.problem.forEach(v => tag(wizProb, v, (el)=>{ [...wizProb.children].forEach(c=>c.classList.remove('active')); el.classList.add('active'); selected.problem=v; refreshWizard(); }));
    WIZ.kpi.forEach(v => tag(wizKpi, v, (el)=>{ el.classList.toggle('active'); if(selected.kpi.has(v)) selected.kpi.delete(v); else selected.kpi.add(v); syncKpiChecks(); refreshWizard(); }));

    function syncKpiChecks(){
      const checks = Array.from(document.querySelectorAll('input[name=\"kpi\"]'));
      checks.forEach(ch => ch.checked = selected.kpi.has(ch.value));
    }

    function wizardSegs(){
      const ind = selected.industry || document.getElementById('industry').value;
      const kpis = Array.from(selected.kpi);
      let segs = deriveSegs(ind, kpis);
      // å›°ã‚Šã”ã¨â†’è¿½åŠ ãƒ«ãƒ¼ãƒ«
      if(selected.problem === "è¢«å®³ã‚’æ¸›ã‚‰ã—ãŸã„") segs.push("SEG_FLOOD","SEG_EMERGENCY");
      if(selected.problem === "å“è³ªã®ãƒ ãƒ©ã‚’æ¸›ã‚‰ã—ãŸã„") segs.push("SEG_AGRI_PROD");
      if(selected.problem === "ç‚¹æ¤œã®æŠœã‘æ¼ã‚Œã‚’é˜²ããŸã„") segs.push("SEG_INFRA_O&M");
      if(selected.problem === "ç’°å¢ƒè² è·/CO2ã‚’æ¸›ã‚‰ã—ãŸã„") segs.push("SEG_REGULATOR","SEG_METHANE");
      return Array.from(new Set(segs));
    }

    function refreshWizard(){
      const segs = wizardSegs();
      if(!selected.industry && !selected.problem && selected.kpi.size===0){ wizSugg.style.display='none'; return; }
      wizSugg.style.display='block';
      wizSugg.innerHTML = `
        <h4>ãŠã™ã™ã‚ï¼š</h4>
        <p>ã‚ãªãŸã«åˆã„ãã†ãªè§£æ±ºä¾‹ï¼š<strong>${segs.join(', ')||'â€”'}</strong></p>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button type="button" class="btn btn-primary" id="wizTry">ã“ã®æ¡ä»¶ã§çµæœã‚’è¦‹ã‚‹</button>
          <button type="button" class="btn btn-ghost" id="wizExplain">ã©ã‚“ãªæ´»ç”¨ãŒã§ãã‚‹ï¼Ÿ</button>
        </div>
      `;
      document.getElementById('wizTry').onclick = ()=>{
        const kpis = Array.from(selected.kpi);
        const payload = {
          industry: document.getElementById('industry').value || selected.industry || "",
          region: document.getElementById('region').value.trim(),
          problem: (document.getElementById('problem').value.trim() || `${selected.problem||''} ã‚’æ”¹å–„ã—ãŸã„`),
          kpis,
          segs
        };
        localStorage.setItem('kakehashi:lastForm', JSON.stringify(payload));
        localStorage.setItem('kakehashi:lastSegs', JSON.stringify(segs));
        const params = new URLSearchParams({ industry:payload.industry, region:payload.region, problem:payload.problem, kpi:kpis.join(',') });
        location.href = 'results.html?' + params.toString();
      };
      document.getElementById('wizExplain').onclick = ()=> alert("åœ°å›³ä¸Šã§â€œã©ã“ã§ãƒ»ã©ã‚Œãã‚‰ã„ãƒ»ã„ã¤â€ãŒåˆ†ã‹ã‚‹ãƒ„ãƒ¼ãƒ«ã‚’ã”ææ¡ˆã—ã¾ã™ã€‚çµæœç”»é¢ã§å…·ä½“çš„ãªã‚·ãƒŠãƒªã‚ªã‚’ã”è¦§ãã ã•ã„ã€‚");
    }

    // === UIå‚ç…§ ===
    const problem = document.getElementById('problem');
    const industry = document.getElementById('industry');
    const region = document.getElementById('region');
    const nlcHint = document.getElementById('nlcHint');
    const segHint = document.getElementById('segHint');
    const charCounter = document.getElementById('charCounter');
    const insertExample = document.getElementById('insertExample');

    // è‡ªç„¶æ–‡â†’æ¨å®š
    problem.addEventListener('input', ()=>{
      const r = classifyIndustry(problem.value);
      if(r){ nlcHint.textContent = `æ¨å®šï¼š${r.label}ï¼ˆä¿¡é ¼åº¦ ${r.confidence.toFixed(2)}ï¼‰`; if(r.confidence>=0.75 && !industry.value) industry.value = r.label; }
      else { nlcHint.textContent = ""; }
      const segs = segsFromText(problem.value);
      segHint.innerHTML = segs.length ? `<span class="badge">æ¤œå‡ºSEG: ${segs.join(", ")}</span>` : "";
      charCounter.textContent = `${problem.value.length} / ${problem.maxLength}`;
    });

    insertExample.addEventListener('click', ()=>{
      problem.value = "è±ªé›¨ã®ã¨ãã€ã©ã®é“è·¯ãŒæµ¸æ°´ã—ã‚„ã™ã„ã‹äº‹å‰ã«æŠŠæ¡ã—ãŸã„ã€‚";
      problem.dispatchEvent(new Event('input'));
    });

    // é€ä¿¡
    document.getElementById('diagForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      let valid = true;
      if(!industry.value){ industry.classList.add('is-invalid'); valid=false; } else industry.classList.remove('is-invalid');
      if(!valid) return;
      const kpis = Array.from(document.querySelectorAll('input[name="kpi"]:checked')).map(i=>i.value);
      const segBase = deriveSegs(industry.value, kpis);
      const segFromText = segsFromText(problem.value);
      const segsAll = Array.from(new Set([...segBase, ...segFromText, ...wizardSegs()]));
      const formPayload = { industry: industry.value, region: region.value.trim(), problem: problem.value.trim(), kpis, segs: segsAll };
      localStorage.setItem('kakehashi:lastForm', JSON.stringify(formPayload));
      localStorage.setItem('kakehashi:lastSegs', JSON.stringify(formPayload.segs||[]));
      const params = new URLSearchParams({ industry:formPayload.industry, region:formPayload.region, problem:formPayload.problem, kpi:kpis.join(',') });
      location.href = 'results.html?' + params.toString();
    });

    // å¾©å…ƒ
    (()=>{
      const last = localStorage.getItem('kakehashi:lastForm');
      if(!last) return;
      try{
        const v = JSON.parse(last);
        if(v.industry) industry.value = v.industry;
        if(v.region)   region.value   = v.region;
        if(v.problem){ problem.value = v.problem; problem.dispatchEvent(new Event('input')); }
        if(Array.isArray(v.kpis)) v.kpis.forEach(k=>{
          const el = Array.from(document.querySelectorAll('input[name="kpi"]')).find(n=>n.value===k);
          if(el) el.checked = true;
          if(el?.checked) selected.kpi.add(k);
        });
        refreshWizard();
      }catch(e){}
    })();
  </script>
</body>
</html>
